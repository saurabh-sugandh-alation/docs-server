
<!DOCTYPE html>
<html lang="" >
<head>
  <meta charset="utf-8"/>
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="book-version"      content=""/>
  <meta name="book-release"      content=""/>
  <meta name="docsearch:name"    content="Alation User Guide" />
  <meta name="docsearch:version" content="" />
  <meta name="docsearch:package_type" content="" />
	<meta name="robots" content="noindex" />

  
  <title>Appendix &mdash; Alation User Guide</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx_collapse.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/rtd_sphinx_search.min.css" type="text/css" />
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Alation User Guide" href="#"/>
        <link rel="up" title="Adding Data Sources" href="index.html"/>
        <link rel="next" title="Compose SSO for Amazon Data Sources" href="../ComposeSSOAWSDataSources/index.html"/>
        <link rel="prev" title="Configure Alation DB" href="ConfigureAlationDB.html"/>

	

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-67846571-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-67846571-1');
	</script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<!-- Second Google Analytics tag to assist mapping with mattermost.com visits --> 
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120238482-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-120238482-1');
	</script>


</head>

<body class="wy-body-for-nav" role="document">

  <header>
    <div class="header__container wy-max-content-width">
        <a href="/" class="header__logo">
            <img width="176" src="../../_static/img/logo-alation.svg" alt="Alation" />
        </a>
        <ul class="header__links">
            <li><a href="https://help.alation.com/s/">Alation Help Center</a></li>
        </ul>
    </div>
</header>

  <div class="wy-grid-for-nav wy-max-content-width">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-scroll__content">
          <div class="wy-side-nav-search">
            

            <ul class="sidebartop">
              <li class="nolink search"><div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search this project" aria-label="Search this project" id="searchinput" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
</li>

            </ul>

            
          </div>

          <div class="wy-menu wy-sidebar wy-sidebar--hidden" data-spy="affix" role="navigation" aria-label="main navigation">
            
              
              
              
                  <p class="caption" role="heading"><span class="caption-text">Welcome to Alation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/About/index.html">About Alation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/CloudAndOnPrem/index.html">Alation Cloud and On-Premise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/UserProfileandPreferences/index.html">User Profile and Preferences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/CatalogBasics/index.html">Catalog Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/CatalogPages/index.html">Catalog Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/Conversations/index.html">Conversations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/Domains/index.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/BestPractices/index.html">Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/Glossary/index.html">Alation Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Alation Cloud Service</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/StatusPage/index.html">Status Page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/CloudOverview/index.html">Cloud Service Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/CloudConfiguration/index.html">Configuration for Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/AlationAgent/index.html">Alation Agent</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Alation Integration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../integration/AlationAnywhere/index.html">Alation Anywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration/AlationConnectedSheets/index.html">Alation Connected Sheets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/ServerInstallation/index.html">Install Alation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/HighAvailability/index.html">High Availability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/Update/index.html">Update Alation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/BackupandRestore/index.html">Back Up and Restore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/LineageV2/index.html">Lineage V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/LineageV3/index.html">Lineage V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/AlationAnalyticsV2/index.html">Alation Analytics V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installconfig/AlationContainerService/index.html">Alation Container Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Sources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sources/CatalogSources/index.html">Catalog Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sources/VirtualDataSources/index.html">Virtual Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sources/Lineage/index.html">Lineage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sources/APIResources/index.html">API Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sources/WorkwithCatalogData/index.html">Working with Catalog Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sources/OpenConnectorFramework/index.html">Open Connector Framework</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Sources</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../DSConfiguration/index.html">Data Source Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Adding Data Sources</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AWSGluewithoutHive.html">AWS Glue without Hive</a></li>
<li class="toctree-l2"><a class="reference internal" href="AzureDataWarehouse.html">Azure Data Warehouse</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cassandra.html">Cassandra</a></li>
<li class="toctree-l2"><a class="reference internal" href="DatabricksAWS.html">Databricks on AWS</a></li>
<li class="toctree-l2"><a class="reference internal" href="DB2LUW.html">DB2 LUW</a></li>
<li class="toctree-l2"><a class="reference internal" href="Greenplum.html">Greenplum</a></li>
<li class="toctree-l2"><a class="reference internal" href="Impala.html">Impala</a></li>
<li class="toctree-l2"><a class="reference internal" href="MongoDB.html">MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="MemSQL.html">MemSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="MySQL.html">MySQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="Netezza.html">Netezza</a></li>
<li class="toctree-l2"><a class="reference internal" href="Oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="PostgreSQL.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="PrestoOnHive.html">Presto on Hive</a></li>
<li class="toctree-l2"><a class="reference internal" href="Redshift.html">Amazon Redshift</a></li>
<li class="toctree-l2"><a class="reference internal" href="Salesforce.html">Salesforce</a></li>
<li class="toctree-l2"><a class="reference internal" href="SAPHANA.html">SAP Hana</a></li>
<li class="toctree-l2"><a class="reference internal" href="SAS.html">SAS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Snowflake.html">Snowflake</a></li>
<li class="toctree-l2"><a class="reference internal" href="SQLServer.html">SQL Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="SybaseIQ.html">Sybase IQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="SybaseASE.html">Sybase Adaptive Server Enterprise (ASE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Teradata.html">Teradata</a></li>
<li class="toctree-l2"><a class="reference internal" href="Vertica.html">Vertica</a></li>
<li class="toctree-l2"><a class="reference internal" href="KerberosConfiguration.html">Kerberos Configuration (General)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ConfigureAlationDB.html">Configure Alation DB</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ComposeSSOAWSDataSources/index.html">Compose SSO for Amazon Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ComposeSSOAzureDataSources/index.html">Compose SSO for Azure Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AuthenticationForExtraction/index.html">Authentication for Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CustomDB/index.html">Custom DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GBQ/index.html">Google BigQuery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Hive/index.html">Hive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BI Sources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bisources/AddBISources/index.html">Add BI Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bisources/AddTableauServer/index.html">Add Tableau Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bisources/WorkwithBISources/index.html">Working with BI Sources</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">File System Sources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/FileSystems/index.html">Add File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/VirtualFileSystems/index.html">Virtual File Systems</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Alation for Analysts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../analyst/UserAuthenticationForDataSources/index.html">User Authentication for Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyst/ShareAndAccessQueries/index.html">Share and Access Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyst/WriteQueries/index.html">Write Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyst/DevelopQueries/index.html">Develop Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyst/WorkwithQueryResults/index.html">Work with Query Results</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Alation for Data Stewards</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../steward/GovernanceApp/index.html">Governance App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/PolicyCenter/index.html">Policy Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/Workflow/index.html">Workflow Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/GovernanceDashboard/index.html">Governance Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/StewardshipWorkbench/index.html">Stewardship Workbench</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/AnalyticsStewardship/index.html">Analytics Stewardship</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/Glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/ArticlesAndTags/index.html">Articles and Tags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/ArticleGroups/index.html">Article Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/DataCatalogCustomization/index.html">Customize Your Data Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/DataDocumentation/index.html">Data Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/AutoTitlingandLexicon/index.html">Auto-titling and Lexicon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../steward/SnowflakeTags/index.html">Snowflake Tags</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Alation for Server Administrators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admins/CustomizableHomePage/index.html">Customizable Homepage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/AdminSettings/index.html">Administrator Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/AdditionalConfiguration/index.html">Additional Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/RunbookForAdministrators/index.html">Runbook for Administrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/AlationAPIs/index.html">Alation APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/How-tos/index.html">How-tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admins/Troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../releases/releasenotes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/supportmatrices/index.html">Support Matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/endofsupport/index.html">End Of Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/snowflakeclladdon/index.html">Snowflake Parser Add-On</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/fieldnotices/index.html">Important Notices and Security Alerts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Archived Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../archive/About/index.html">About the Documentation Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/AdminConfig/index.html">Administration and Update Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/ReleaseNotes/index.html">Release Notes Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/Usage/index.html">Usage and Customization Archive</a></li>
</ul>

              
            
          </div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="wy-nav-top-icon"></i>
        <a href="../../index.html">Alation User Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">

          <div role="navigation" aria-label="breadcrumbs" class="breadcrumbs">
    <a href="../../index.html">Docs</a>
    <span class="separator">&gt;</span>
    <a href="index.html">Adding Data Sources</a>
    <span class="separator">&gt;</span>
    <span>Appendix</span>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody" class="toBeIndexed">
            
  <section id="appendix">
<h1>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h1>
<section id="a-1a-sql-server-extended-events-session-creation">
<span id="appendix-1a"></span><h2>A.1a SQL Server Extended Events Session Creation<a class="headerlink" href="#a-1a-sql-server-extended-events-session-creation" title="Permalink to this headline">¶</a></h2>
<section id="query-to-create-extended-events-session">
<h3>Query to create extended events session<a class="headerlink" href="#query-to-create-extended-events-session" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-- Query to create an extended events session</span>
<span class="go">CREATE EVENT SESSION [alation_query_log] ON SERVER</span>
<span class="go">ADD EVENT sqlserver.sp_statement_completed</span>
<span class="go">(</span>
<span class="go">  ACTION</span>
<span class="go">    (</span>
<span class="go">      package0.collect_system_time,</span>
<span class="go">      package0.event_sequence,</span>
<span class="go">      sqlos.task_time,</span>
<span class="go">      sqlserver.client_app_name,</span>
<span class="go">      sqlserver.database_id,</span>
<span class="go">      sqlserver.database_name,</span>
<span class="go">      sqlserver.nt_username,</span>
<span class="go">      sqlserver.server_principal_name,</span>
<span class="go">      sqlserver.server_principal_sid,</span>
<span class="go">      sqlserver.session_id,</span>
<span class="go">      sqlserver.session_nt_username,</span>
<span class="go">      sqlserver.transaction_id,</span>
<span class="go">      sqlserver.username</span>
<span class="go">      )</span>
<span class="go">    WHERE</span>
<span class="go">    -- Lineage and context queries:</span>
<span class="go">    (</span>
<span class="go">      (</span>
<span class="go">         (</span>
<span class="go">                [statement] like &#39;%ALTER %&#39; OR</span>
<span class="go">                [statement] like &#39;%CREATE %&#39; OR</span>
<span class="go">                [statement] like &#39;%DROP %&#39;   OR</span>
<span class="go">                [statement] like &#39;%TRUNCATE %&#39; OR</span>
<span class="go">                [statement] like &#39;%MERGE %&#39; OR</span>
<span class="go">    -- INSERT statements can be of type &quot;SELECT INTO ...&quot; or &quot;INSERT INTO ...&quot;</span>
<span class="go">                [statement] like &#39;%SELECT % INTO %&#39; OR</span>
<span class="go">                [statement] like &#39;%INSERT INTO % FROM %&#39; OR</span>
<span class="go">                [statement] like &#39;%UPDATE %FROM %&#39; OR</span>
<span class="go">                [statement] like &#39;%USE %&#39;</span>
<span class="go">            )</span>

<span class="go">    -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">    -- This specifies sampling 1 out of 20 queries that may contribute to table lineage</span>
<span class="go">    -- Start with this and if ingestion is successful, try scaling back the sampling</span>
<span class="go">    -- by decreasing 20 or comment out the line below to remove sampling altogether</span>
<span class="go">    -- Keep in mind that as long as this is sampled some lineage will be missing</span>

<span class="go">            AND package0.divides_by_uint64(package0.counter, 20)</span>

<span class="go">    -- Uncomment the following lines if you wish to limit sampling to specific databases.</span>
<span class="go">    -- Provide appropriate database names instead of placeholder names DB1, DB2, DB3, etc.</span>
<span class="go">    -- Or alternatively, use database_id.</span>

<span class="go">            -- AND  ([sqlserver].[database_name]= N&#39;DB1&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name]= N&#39;DB2&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name]= N&#39;DB3&#39;)</span>

<span class="go">    -- Alternatively, you can use database_id.</span>
<span class="go">    -- To get the database id, run:  SELECT DB_ID (&#39;database name&#39;) in SSMS or any query tool.</span>
<span class="go">    -- Provide the specific database id’s in place of &lt;integer1-3&gt;:</span>

<span class="go">            -- AND ([sqlserver].[database_id] = &lt;integer1&gt; OR</span>
<span class="go">            -- [sqlserver].[database_id] = &lt;integer2&gt; OR</span>
<span class="go">            -- [sqlserver].[database_id] = &lt;integer3&gt;)</span>

<span class="go">    -- Uncomment the following line if you wish to filter out queries by users.</span>
<span class="go">    -- This is SQL server username. Provide the appropriate user name instead of the placeholder name user:</span>
<span class="go">            -- AND [sqlserver].[username]=N&#39;user&#39;</span>
<span class="go">            )</span>
<span class="go">            OR</span>
<span class="go">            (</span>
<span class="go">            -- Includes all SELECT queries</span>
<span class="go">                [statement] like &#39;%FROM %&#39;</span>

<span class="go">    -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">    -- This specifies sampling 1 out of 20 non lineage queries. Start with this and if</span>
<span class="go">    -- ingestion is successful try scaling back the sampling by lowering 20 or comment out</span>
<span class="go">    -- the line below to remove sampling altogether:</span>

<span class="go">            AND package0.divides_by_uint64(package0.counter, 20)</span>

<span class="go">    -- Uncomment the following lines if you wish to limit sampling to specific databases.</span>
<span class="go">    -- Provide appropriate database names instead of placeholder names DB1, DB2, DB3.</span>
<span class="go">    -- Or alternatively, use database_id.</span>

<span class="go">            -- AND  ([sqlserver].[database_name] = N&#39;DB1&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name] = N&#39;DB2&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name] = N&#39;DB3&#39; )</span>

<span class="go">    -- Uncomment the following lines if you wish to filter out queries by users.</span>
<span class="go">    -- This is SQL server username. Provide the appropriate user name instead of the placeholder name user:</span>
<span class="go">            -- AND [sqlserver].[username] = N&#39;user&#39;</span>
<span class="go">            )</span>
<span class="go">          )</span>
<span class="go">        ),</span>
<span class="go">        ADD EVENT sqlserver.sql_statement_completed</span>
<span class="go">        (</span>
<span class="go">          SET collect_statement=(1)</span>
<span class="go">          ACTION</span>
<span class="go">            (</span>
<span class="go">              package0.collect_system_time,</span>
<span class="go">              package0.event_sequence,</span>
<span class="go">              sqlos.task_time,</span>
<span class="go">              sqlserver.client_app_name,</span>
<span class="go">              sqlserver.database_id,</span>
<span class="go">              sqlserver.database_name,</span>
<span class="go">              sqlserver.nt_username,</span>
<span class="go">              sqlserver.server_instance_name,</span>
<span class="go">              sqlserver.server_principal_name,</span>
<span class="go">              sqlserver.session_id,</span>
<span class="go">              sqlserver.session_nt_username,</span>
<span class="go">              sqlserver.transaction_id,</span>
<span class="go">              sqlserver.username</span>
<span class="go">              )</span>
<span class="go">    -- Generic Alation filters, we only make use of certain types of statements</span>
<span class="go">    -- Note SELECT is omitted because SELECT without FROM is not useful for our analysis</span>
<span class="go">              WHERE</span>
<span class="go">              -- Lineage and context queries:</span>
<span class="go">                (</span>
<span class="go">                  (</span>
<span class="go">                    (</span>
<span class="go">                      [statement] like &#39;%ALTER %&#39; OR</span>
<span class="go">                      [statement] like &#39;%CREATE %&#39; OR</span>
<span class="go">                      [statement] like &#39;%DROP %&#39; OR</span>
<span class="go">                      [statement] like &#39;%TRUNCATE %&#39; OR</span>
<span class="go">                      [statement] like &#39;%MERGE %&#39; OR</span>
<span class="go">              -- INSERT statements can be of the form &quot;SELECT INTO ...&quot; or &quot;INSERT INTO ...&quot;</span>
<span class="go">                      [statement] like &#39;%SELECT % INTO %&#39; OR</span>
<span class="go">                      [statement] like &#39;%INSERT INTO % FROM %&#39; OR</span>
<span class="go">                      [statement] like &#39;%UPDATE % FROM %&#39; OR</span>
<span class="go">                      [statement] like &#39;%USE %&#39;</span>
<span class="go">                      )</span>
<span class="go">    -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">    -- This specifies sampling 1 out of 20 queries that may contribute to table lineage.</span>
<span class="go">    -- Start with this and if ingestion is successful try scaling back the sampling by lowering</span>
<span class="go">    -- 20 or comment out the below line to remove sampling altogether.</span>
<span class="go">    -- Keep in mind that as long as this is sampled some lineage will be missing</span>

<span class="go">              AND package0.divides_by_uint64(package0.counter, 20)</span>

<span class="go">    -- Uncomment the following lines if you wish to limit sampling to specific databases.</span>
<span class="go">    -- Provide appropriate database names instead of placeholder names DB1, DB2, DB3.</span>
<span class="go">    -- Or alternatively, use database_id.</span>
<span class="go">              -- AND  ([sqlserver].[database_name]= N&#39;DB1&#39; OR</span>
<span class="go">              -- [sqlserver].[database_name]= N&#39;DB2&#39; OR</span>
<span class="go">              -- [sqlserver].[database_name]= N&#39;DB3&#39; )</span>

<span class="go">    -- Uncomment the following lines if you wish to filter out queries by users.</span>
<span class="go">    -- This is SQL server username. Provide the appropriate user name instead of the placeholder name user:</span>
<span class="go">              -- AND [sqlserver].[username]=N&#39;user&#39;</span>
<span class="go">              )</span>
<span class="go">              OR</span>
<span class="go">                (</span>
<span class="go">              -- Includes all SELECT queries:</span>
<span class="go">              [statement] like &#39;%FROM %&#39;</span>
<span class="go">    -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">    -- This specifies sampling 1 out of 20 non lineage queries. Start with this and if</span>
<span class="go">    -- ingestion is successful try scaling back the sampling by lowering 20 or comment out</span>
<span class="go">    -- the line below to remove sampling altogether:</span>

<span class="go">            AND package0.divides_by_uint64(package0.counter, 20)</span>

<span class="go">    -- Uncomment the following lines if you wish to limit sampling to specific databases.</span>
<span class="go">    -- Provide appropriate database names instead of placeholder names DB1, DB2, DB3.</span>
<span class="go">    -- Or alternatively, use database_id.</span>

<span class="go">            -- AND  ([sqlserver].[database_name]= N&#39;DB1&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name]= N&#39;DB2&#39; OR</span>
<span class="go">            -- [sqlserver].[database_name]= N&#39;DB3&#39; )</span>

<span class="go">    -- Uncomment the following lines if you wish to filter out queries by users.</span>
<span class="go">    -- This is SQL server username. Provide the appropriate user name instead of the placeholder name user:</span>
<span class="go">            -- AND [sqlserver].[username]=N&#39;user&#39;</span>
<span class="go">                    )</span>
<span class="go">                  )</span>
<span class="go">                )</span>
<span class="go">            ADD TARGET package0.event_file</span>
<span class="go">            (</span>
<span class="go">            -- CONFIGURE THIS:</span>
<span class="go">              SET filename=N&#39;C:\Users\Public\Documents\test\alation_query_log.xel&#39;,</span>
<span class="go">            -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">            -- Note: Alation will read one file at a time so this is the size of the file that may be read into memory while it is being fetched.</span>
<span class="go">            -- max file size in MB before rolling over:</span>
<span class="go">              max_file_size=(100), -- in MB</span>
<span class="go">            -- OPTIONALLY CONFIGURE THIS:</span>
<span class="go">              max_rollover_files=(100)</span>
<span class="go">              )</span>
<span class="go">              WITH</span>
<span class="go">              (</span>
<span class="go">            -- OPTIONALLY CONFIGURE THIS. The total event buffer size:</span>
<span class="go">              MAX_MEMORY=50 MB,</span>
<span class="go">            -- If buffer is full, events will be dropped instead of blocking the server:</span>
<span class="go">              EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,</span>
<span class="go">            -- OPTIONALLY CONFIGURE THIS. Max time before writing events to storage:</span>
<span class="go">              MAX_DISPATCH_LATENCY=30 SECONDS,</span>
<span class="go">            -- Any events that are too large to fit in the buffer will be dropped:</span>
<span class="go">              MAX_EVENT_SIZE=0 KB,</span>
<span class="go">              MEMORY_PARTITION_MODE=NONE,</span>
<span class="go">              TRACK_CAUSALITY=OFF,</span>
<span class="go">              STARTUP_STATE=ON</span>
<span class="go">              );</span>
<span class="go">              GO</span>
<span class="go">  -- Query to start the session (change START -&gt; STOP to stop it)</span>
<span class="go">  ALTER EVENT SESSION [alation_query_log] ON SERVER</span>
<span class="go">  STATE = START;</span>
<span class="go">  GO</span>
</pre></div>
</div>
<section id="query-to-delete-and-recreate-the-session">
<h4>Query to Delete and Recreate the Session<a class="headerlink" href="#query-to-delete-and-recreate-the-session" title="Permalink to this headline">¶</a></h4>
<p>If you want to recreate the session, you need to first drop the existing session.</p>
<p>Use the following query to delete a session:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">DROP EVENT SESSION [alation_query_log] ON SERVER;</span>
<span class="go">GO</span>

<span class="go">-- Check if the session is dropping events and see other data about the session</span>
</pre></div>
</div>
</section>
</section>
<section id="using-database-id-instead-of-database-name">
<h3>Using Database ID instead of Database Name<a class="headerlink" href="#using-database-id-instead-of-database-name" title="Permalink to this headline">¶</a></h3>
<p>If you wish to limit sampling to specific databases, you can either provide <code class="docutils literal notranslate"><span class="pre">database_name</span></code> or <code class="docutils literal notranslate"><span class="pre">database_id</span></code>.</p>
<p>To get the database id:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>SELECT<span class="w"> </span>DB_ID<span class="w"> </span><span class="o">(</span><span class="s1">&#39;database name&#39;</span><span class="o">)</span>
</pre></div>
</div>
<p>This command can be run in SSMS or any query tool.</p>
<p>Provide the specific database id’s in place of &lt;integer&gt; in the appropriate sections of the query. Comments explain where you can alternatively use <code class="docutils literal notranslate"><span class="pre">database_name</span></code> or <code class="docutils literal notranslate"><span class="pre">database_id</span></code>:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>AND<span class="w"> </span><span class="o">[</span>sqlserver<span class="o">]</span>.<span class="o">[</span>database_id<span class="o">]=</span>&lt;integer&gt;
</pre></div>
</div>
</section>
</section>
<section id="a-1b-sql-server-2008-extended-events-session-creation">
<span id="appendix-1b"></span><h2>A.1b SQL Server 2008 Extended Events Session Creation<a class="headerlink" href="#a-1b-sql-server-2008-extended-events-session-creation" title="Permalink to this headline">¶</a></h2>
<section id="query-to-create-extended-events-session-sql-server-2008">
<h3>Query To create extended events session SQL Server 2008<a class="headerlink" href="#query-to-create-extended-events-session-sql-server-2008" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">--Query To Create Extended Events Session</span>
<span class="go">CREATE EVENT SESSION alation_query_log ON SERVER</span>
<span class="go">ADD EVENT sqlserver.sql_statement_completed(</span>
<span class="go">    ACTION(</span>
<span class="go">      package0.collect_system_time,</span>
<span class="go">      sqlos.task_time,</span>
<span class="go">      sqlserver.client_app_name,</span>
<span class="go">      sqlserver.database_id,</span>
<span class="go">      sqlserver.nt_username,</span>
<span class="go">      sqlserver.session_id,</span>
<span class="go">      sqlserver.session_nt_username,</span>
<span class="go">      sqlserver.transaction_id,</span>
<span class="go">      sqlserver.username,</span>
<span class="go">      sqlserver.sql_text</span>
<span class="go">    )</span>
<span class="go">  )</span>
<span class="go">ADD</span>
<span class="go">  TARGET package0.asynchronous_file_target(</span>
<span class="go">    SET filename = N&#39;C:UsersPublicDocumentsalation_query_log.xel&#39;,</span>
<span class="go">      -- CONFIGURE THIS</span>
<span class="go">      -- OPTIONALLY CONFIGURE THIS, max file size in MB before rolling over</span>
<span class="go">      -- Note Alation will read one file at a time so this is the size of file that may be</span>
<span class="go">      -- read into memory while it is being fetched</span>
<span class="go">      max_file_size =(100), -- in MB</span>
<span class="go">      max_rollover_files =(100)</span>
<span class="go">  )</span>
<span class="go">  -- OPTIONALLY CONFIGURE THIS</span>
<span class="go">  WITH (</span>
<span class="go">    MAX_MEMORY = 50 MB,</span>
<span class="go">    -- OPTIONALLY CONFIGURE THIS, the total event buffer size</span>
<span class="go">    EVENT_RETENTION_MODE = ALLOW_SINGLE_EVENT_LOSS,</span>
<span class="go">    -- If buffer is full events will be dropped instead of blocking the server</span>
<span class="go">    MAX_DISPATCH_LATENCY = 30 SECONDS,</span>
<span class="go">    -- OPTIONALLY CONFIGURE THIS, max time before writing events to storage</span>
<span class="go">    MAX_EVENT_SIZE = 0 KB,</span>
<span class="go">    -- Any events that are too large to fit in the buffer will be dropped</span>
<span class="go">    MEMORY_PARTITION_MODE = NONE,</span>
<span class="go">    TRACK_CAUSALITY = OFF,</span>
<span class="go">    STARTUP_STATE = ON</span>
<span class="go">  )</span>
<span class="go">GO</span>
<span class="go">-- Query to start the session (change START -&gt; STOP to stop it)</span>
<span class="go">ALTER EVENT SESSION alation_query_log ON SERVER STATE = START</span>
<span class="go">GO</span>
<span class="go">-- If you need to delete and recreate the session this is the syntax to drop it.</span>
<span class="go">DROP EVENT SESSION [alation_query_log] ON SERVER</span>
<span class="go">GO</span>
<span class="go">-- Check if the session is dropping events and see other data about the session</span>
<span class="go">SELECT * FROM sys.dm_xe_sessions;</span>
<span class="go">  -- Check if Alation service account can see the log files by running this as the Alation service account</span>
<span class="go">  -- Change the path in the example to the location of the log files</span>
<span class="go">  EXEC xp_dirtree ‘ C: / path / to / log / files / ’, 0, 1</span>
</pre></div>
</div>
</section>
</section>
<section id="a-1c-sql-server-trace-script">
<span id="appendix-1c"></span><h2>A.1c SQL Server Trace Script<a class="headerlink" href="#a-1c-sql-server-trace-script" title="Permalink to this headline">¶</a></h2>
<p>Adjust <code class="docutils literal notranslate"><span class="pre">stoptime</span></code>, <code class="docutils literal notranslate"><span class="pre">tracefile</span></code>, <code class="docutils literal notranslate"><span class="pre">maxfilesize</span></code>, and <code class="docutils literal notranslate"><span class="pre">filecount</span></code> variables in the script.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">//</span>
<span class="go">/* Created by: SQL Server 2012  Profiler          */</span>
<span class="go">/* Date: 05/19/2015  00:27:35 AM                  */</span>
<span class="go">//</span>

<span class="go">-- Create a Queue</span>
<span class="go">declare @rc int</span>
<span class="go">declare @TraceID int</span>
<span class="go">declare @maxfilesize bigint</span>
<span class="go">declare @stoptime datetime</span>
<span class="go">declare @filecount int</span>
<span class="go">declare @tracefile nvarchar(245)</span>

<span class="go">-- maxfilesize is in MB</span>
<span class="go">set @maxfilesize = 1024</span>
<span class="go">-- Set stoptime to NULL to run forever</span>
<span class="go">set @stoptime = &#39;2015-06-19 15:06:00.000&#39;</span>
<span class="go">-- Max number of rotated trace files to keep</span>
<span class="go">set @filecount = 40</span>

<span class="go">-- Please replace the text InsertFileNameHere, with an appropriate</span>
<span class="go">-- filename prefixed by a path, for example, c:MyFolderMyTrace. The .trc extension</span>
<span class="go">-- will be appended to the filename automatically. If you are writing from</span>
<span class="go">-- remote server to local drive, please use UNC path and make sure server has</span>
<span class="go">-- write access to your network share</span>
<span class="go">set @tracefile = N&#39;c:AlationServerTrace1&#39;</span>

<span class="go">exec @rc = sp_trace_create @TraceID output, 2, @tracefile, @maxfilesize, @stoptime, @filecount</span>
<span class="go">if (@rc != 0) goto error</span>

<span class="go">-- Client side File and Table cannot be scripted</span>

<span class="go">-- Set the events required by Alation</span>
<span class="go">declare @on bit</span>
<span class="go">set @on = 1</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 1, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 6, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 10, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 11, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 12, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 13, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 14, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 15, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 16, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 17, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 18, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 35, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 45, 48, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 1, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 6, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 10, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 11, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 12, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 13, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 14, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 15, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 16, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 17, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 18, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 35, @on</span>
<span class="go">exec sp_trace_setevent @TraceID, 41, 48, @on</span>

<span class="go">-- Set the Filters</span>
<span class="go">declare @intfilter int</span>
<span class="go">declare @bigintfilter bigint</span>

<span class="go">-- Filter out all queries by Trace: ApplicationName NOT LIKE &#39;SQL Server Profiler%&#39;</span>
<span class="go">exec sp_trace_setfilter @TraceID, 10, 0, 7, N&#39;SQL Server Profiler%&#39;</span>
<span class="go">-- Filter out all queries by SQL Server Mgmt Studio IntelliSense</span>
<span class="go">exec sp_trace_setfilter @TraceID, 10, 0, 7, N&#39;%Transact-SQL</span>
<span class="go">IntelliSense%&#39;</span>
<span class="go">-- Log only user queries: isSystem = 0</span>
<span class="go">exec sp_trace_setfilter @TraceID, 60, 0, 0, 0</span>

<span class="go">-- **</span>
<span class="go">-- TODO: FILTER OUT OTHER UNWANTED QUERIES HERE</span>
<span class="go">-- Filter Queries from a DB</span>
<span class="go">-- NOTE: If your query doesn&#39;t explicitly call &#39;USE DB_NAME&#39; then the DatabaseName</span>
<span class="go">-- column will not be valid.</span>
<span class="go">-- exec sp_trace_setfilter @TraceID, 35, 0, 0, N&#39;MyDatabase&#39;</span>
<span class="go">-- **</span>

<span class="go">-- Set the trace status to start</span>
<span class="go">exec sp_trace_setstatus @TraceID, 1</span>
<span class="go">-- display trace id for future references</span>
<span class="go">select TraceID=@TraceID</span>
<span class="go">goto finish</span>
<span class="go">error:</span>
<span class="go">select ErrorCode=@rc</span>
<span class="go">finish:</span>
<span class="go">go</span>
</pre></div>
</div>
</section>
<section id="a-1d-sql-server-ingestion-from-custom-table-setup">
<span id="appendix-1d"></span><h2>A.1d SQL Server Ingestion from Custom Table Setup<a class="headerlink" href="#a-1d-sql-server-ingestion-from-custom-table-setup" title="Permalink to this headline">¶</a></h2>
<p>The Alation SQL Server ingestion expects a table with specific columns.
They are a subset of the <a class="reference external" href="https://docs.microsoft.com/en-us/sql/tools/sql-server-profiler/sql-server-profiler?view=sql-server-ver15">SQL Profiler Data Columns</a>.</p>
<p>The columns listed in both sections below must all be present. Some of
the required columns must be present and correctly filled, others can
have null values as they are not essential to the ingestion process.</p>
<p>Columns that are required to be filled correctly:</p>
<ul class="simple">
<li><p>LoginName</p></li>
<li><p>SPID</p></li>
<li><p>TextData</p></li>
<li><p>StartTime</p></li>
<li><p>DatabaseName</p></li>
<li><p>EndTime (we filter out queries that haven’t finished so this can be
faked by making it non null)</p></li>
</ul>
<p>Columns that must be present but are not required for ingestion to
function:</p>
<ul class="simple">
<li><p>ApplicationName</p></li>
<li><p>Reads</p></li>
<li><p>Writes</p></li>
<li><p>CPU</p></li>
<li><p>RowCounts</p></li>
<li><p>NTUserName</p></li>
<li><p>EventClass</p></li>
<li><p>Duration</p></li>
</ul>
<p>Additionally, in the logging process, we usually filter out queries that
we know aren’t useful to Alation. You would know best what kind of
queries are being logged but if there is a large volume you may need to
filter them down before putting them in the table. We suggest the
following filters:</p>
<ul class="simple">
<li><p>TextData like ‘%ALTER %’ OR</p></li>
<li><p>TextData like ‘%CREATE %’ OR</p></li>
<li><p>TextData like ‘%DROP %’ OR</p></li>
<li><p>TextData like ‘%TRUNCATE %’ OR</p></li>
<li><p>TextData like ‘%MERGE %’ OR</p></li>
<li><p>TextData like ‘%FROM %’ OR</p></li>
<li><p>TextData like ‘%USE %’</p></li>
</ul>
</section>
<section id="a-2-teradata-query-log-view-sql">
<h2>A.2 Teradata Query Log View SQL<a class="headerlink" href="#a-2-teradata-query-log-view-sql" title="Permalink to this headline">¶</a></h2>
<p>Use the following query to create a Query Log view.</p>
<ul class="simple">
<li><p>Change <code class="docutils literal notranslate"><span class="pre">my_schema.qrylog_full</span></code> to a custom name.</p></li>
<li><p>It is recommended to create <code class="docutils literal notranslate"><span class="pre">qrylog_full</span></code> table in a schema owned by
Alation DB account.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you archive queries in PDCR or another schema, change the source schema from DBC to the other schema.</p>
</div>
<section id="dbc">
<h3>DBC<a class="headerlink" href="#dbc" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="p">.</span><span class="n">QRYLOG_FULL</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">ProcID</span><span class="p">,</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">CollectTimeStamp</span><span class="p">,</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">QueryID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserID</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctString</span><span class="p">,</span>
<span class="w">   </span><span class="n">ExpandAcctString</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionID</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogicalHostID</span><span class="p">,</span>
<span class="w">   </span><span class="n">RequestNum</span><span class="p">,</span>
<span class="w">   </span><span class="n">InternalRequestNum</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogonDateTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringHour</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringDate</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogonSource</span><span class="p">,</span>
<span class="w">   </span><span class="n">AppID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientAddr</span><span class="p">,</span>
<span class="w">   </span><span class="n">QueryBand</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProfileID</span><span class="p">,</span>
<span class="w">   </span><span class="n">StartTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">FirstStepTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">FirstRespTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">LastStateChange</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumSteps</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumStepswPar</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxStepsInPar</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumResultRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TotalIOCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">AMPCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">UtilityByteCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">UtilityRowCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorCode</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorText</span><span class="p">,</span>
<span class="w">   </span><span class="n">WarningOnly</span><span class="p">,</span>
<span class="w">   </span><span class="p">((</span><span class="n">firstresptime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">starttime</span><span class="p">)</span><span class="w"> </span><span class="n">hour</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">second</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">Named</span><span class="w"> </span><span class="n">ElapsedTime</span><span class="p">),</span>
<span class="w">   </span><span class="n">DelayTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AbortFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">CacheFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">StatementType</span><span class="p">,</span>
<span class="w">   </span><span class="n">StatementGroup</span><span class="p">,</span>
<span class="w">   </span><span class="n">sqltextinfo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">QueryText</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumOfActiveAMPs</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAMPCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxCPUAmpNumber</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAmpIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxIOAmpNumber</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">SpoolUsage</span><span class="p">,</span>
<span class="w">   </span><span class="n">WDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">OpEnvID</span><span class="p">,</span>
<span class="w">   </span><span class="n">SysConID</span><span class="p">,</span>
<span class="w">   </span><span class="n">LSN</span><span class="p">,</span>
<span class="w">   </span><span class="n">NoClassification</span><span class="p">,</span>
<span class="w">   </span><span class="n">WDOverride</span><span class="p">,</span>
<span class="w">   </span><span class="n">ResponseTimeMet</span><span class="p">,</span>
<span class="w">   </span><span class="n">ExceptionValue</span><span class="p">,</span>
<span class="w">   </span><span class="n">FinalWDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstMaxRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstLastRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstTotalTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMAllAmpFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMConfLevelUsed</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMRuleID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserName</span><span class="p">,</span>
<span class="w">   </span><span class="n">DefaultDatabase</span><span class="p">,</span>
<span class="w">   </span><span class="n">AMPCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAMPCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxCPUAmpNumberNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstResultRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstProcTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstMaxRowCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProxyUser</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProxyRole</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionTemporalQualifier</span><span class="p">,</span>
<span class="w">   </span><span class="n">CalendarName</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionWDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">DataCollectAlg</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserExpReq</span><span class="p">,</span>
<span class="w">   </span><span class="n">CallNestingLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumRequestCtx</span><span class="p">,</span>
<span class="w">   </span><span class="n">KeepFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">QueryRedriven</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReDriveKind</span><span class="p">,</span>
<span class="w">   </span><span class="n">CPUDecayLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">IODecayLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">TacticalCPUException</span><span class="p">,</span>
<span class="w">   </span><span class="n">TacticalIOException</span><span class="p">,</span>
<span class="w">   </span><span class="n">SeqRespTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqIOKB</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqPhysIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqPhysIOKB</span><span class="p">,</span>
<span class="w">   </span><span class="n">r</span><span class="p">.</span><span class="n">sqlrowno</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">dbc</span><span class="p">.</span><span class="n">dbqlsqltbl</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">     </span><span class="n">dbc</span><span class="p">.</span><span class="n">dbqlogtbl</span><span class="w"> </span><span class="n">s</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">queryid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">queryid</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">procid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">procid</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="reduced-query-log-view">
<h3>Reduced Query Log View<a class="headerlink" href="#reduced-query-log-view" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="p">.</span><span class="n">query_log_reduced</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">QueryID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserID</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserName</span><span class="p">,</span>
<span class="w">   </span><span class="n">AppID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientAddr</span><span class="p">,</span>
<span class="w">   </span><span class="n">StartTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">sqltextinfo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">QueryText</span><span class="p">,</span>
<span class="w">   </span><span class="p">((</span><span class="n">firstresptime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">starttime</span><span class="p">)</span><span class="w"> </span><span class="n">hour</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">second</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">Named</span><span class="w"> </span><span class="n">ElapsedTime</span><span class="p">),</span>
<span class="w">   </span><span class="n">DelayTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">DefaultDatabase</span><span class="p">,</span>
<span class="w">   </span><span class="n">AbortFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumResultRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TotalIOCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">AMPCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorCode</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorText</span><span class="p">,</span>
<span class="w">   </span><span class="n">RequestNum</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogonDateTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">r</span><span class="p">.</span><span class="n">sqlrowno</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">dbc</span><span class="p">.</span><span class="n">dbqlsqltbl</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">    </span><span class="n">dbc</span><span class="p">.</span><span class="n">dbqlogtbl</span><span class="w"> </span><span class="n">s</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">queryid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">queryid</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">procid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">procid</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="pdcr">
<h3>PDCR<a class="headerlink" href="#pdcr" title="Permalink to this headline">¶</a></h3>
<p>If PDCR tables are used, change the source schema (pdcr is used
in this example) and add the date partition column (logDate is usually
the partition column and is used in this example).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="p">.</span><span class="n">QRYLOG_FULL</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">ProcID</span><span class="p">,</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">CollectTimeStamp</span><span class="p">,</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">QueryID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserID</span><span class="p">,</span>
<span class="w">   </span><span class="n">s</span><span class="p">.</span><span class="n">logDate</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctString</span><span class="p">,</span>
<span class="w">   </span><span class="n">ExpandAcctString</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionID</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogicalHostID</span><span class="p">,</span>
<span class="w">   </span><span class="n">RequestNum</span><span class="p">,</span>
<span class="w">   </span><span class="n">InternalRequestNum</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogonDateTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringHour</span><span class="p">,</span>
<span class="w">   </span><span class="n">AcctStringDate</span><span class="p">,</span>
<span class="w">   </span><span class="n">LogonSource</span><span class="p">,</span>
<span class="w">   </span><span class="n">AppID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientID</span><span class="p">,</span>
<span class="w">   </span><span class="n">ClientAddr</span><span class="p">,</span>
<span class="w">   </span><span class="n">QueryBand</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProfileID</span><span class="p">,</span>
<span class="w">   </span><span class="n">StartTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">FirstStepTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">FirstRespTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">LastStateChange</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumSteps</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumStepswPar</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxStepsInPar</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumResultRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TotalIOCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">AMPCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">UtilityByteCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">UtilityRowCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorCode</span><span class="p">,</span>
<span class="w">   </span><span class="n">ErrorText</span><span class="p">,</span>
<span class="w">   </span><span class="n">WarningOnly</span><span class="p">,</span>
<span class="w">   </span><span class="p">((</span><span class="n">firstresptime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">starttime</span><span class="p">)</span><span class="w"> </span><span class="n">hour</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">second</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">Named</span><span class="w"> </span><span class="n">ElapsedTime</span><span class="p">),</span>
<span class="w">   </span><span class="n">DelayTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">AbortFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">CacheFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">StatementType</span><span class="p">,</span>
<span class="w">   </span><span class="n">StatementGroup</span><span class="p">,</span>
<span class="w">   </span><span class="n">sqltextinfo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">QueryText</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumOfActiveAMPs</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAMPCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxCPUAmpNumber</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpCPUTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAmpIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxIOAmpNumber</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">SpoolUsage</span><span class="p">,</span>
<span class="w">   </span><span class="n">WDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">OpEnvID</span><span class="p">,</span>
<span class="w">   </span><span class="n">SysConID</span><span class="p">,</span>
<span class="w">   </span><span class="n">LSN</span><span class="p">,</span>
<span class="w">   </span><span class="n">NoClassification</span><span class="p">,</span>
<span class="w">   </span><span class="n">WDOverride</span><span class="p">,</span>
<span class="w">   </span><span class="n">ResponseTimeMet</span><span class="p">,</span>
<span class="w">   </span><span class="n">ExceptionValue</span><span class="p">,</span>
<span class="w">   </span><span class="n">FinalWDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstMaxRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstLastRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMEstTotalTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMAllAmpFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMConfLevelUsed</span><span class="p">,</span>
<span class="w">   </span><span class="n">TDWMRuleID</span><span class="p">,</span>
<span class="w">   </span><span class="n">UserName</span><span class="p">,</span>
<span class="w">   </span><span class="n">DefaultDatabase</span><span class="p">,</span>
<span class="w">   </span><span class="n">AMPCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxAMPCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MaxCPUAmpNumberNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">MinAmpCPUTimeNorm</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstResultRows</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstProcTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">EstMaxRowCount</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProxyUser</span><span class="p">,</span>
<span class="w">   </span><span class="n">ProxyRole</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionTemporalQualifier</span><span class="p">,</span>
<span class="w">   </span><span class="n">CalendarName</span><span class="p">,</span>
<span class="w">   </span><span class="n">SessionWDID</span><span class="p">,</span>
<span class="w">   </span><span class="n">DataCollectAlg</span><span class="p">,</span>
<span class="w">   </span><span class="n">ParserExpReq</span><span class="p">,</span>
<span class="w">   </span><span class="n">CallNestingLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">NumRequestCtx</span><span class="p">,</span>
<span class="w">   </span><span class="n">KeepFlag</span><span class="p">,</span>
<span class="w">   </span><span class="n">QueryRedriven</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReDriveKind</span><span class="p">,</span>
<span class="w">   </span><span class="n">CPUDecayLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">IODecayLevel</span><span class="p">,</span>
<span class="w">   </span><span class="n">TacticalCPUException</span><span class="p">,</span>
<span class="w">   </span><span class="n">TacticalIOException</span><span class="p">,</span>
<span class="w">   </span><span class="n">SeqRespTime</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqIOKB</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqPhysIO</span><span class="p">,</span>
<span class="w">   </span><span class="n">ReqPhysIOKB</span><span class="p">,</span>
<span class="w">   </span><span class="n">r</span><span class="p">.</span><span class="n">sqlrowno</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pdcr</span><span class="p">.</span><span class="n">dbqlsqltbl</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">    </span><span class="n">pdcr</span><span class="p">.</span><span class="n">dbqlogtbl</span><span class="w"> </span><span class="n">s</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">queryid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">queryid</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">procid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">procid</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">logDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">logDate</span><span class="p">;</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">my_schema</span></code> is not owned by the Alation DB account, provide SELECT
privileges to the Alation DB account on Query Log view by running the
following queries:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">DBC</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">GRANT</span><span class="w"> </span><span class="k">OPTION</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">ALATION_DB_USER</span><span class="p">;</span>
</pre></div>
</div>
<p>Verify the setup by running the following query asalation_db_user.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="p">.</span><span class="n">QRYLOG_FULL</span><span class="p">;</span>
</pre></div>
</div>
<p>Typical query run during extraction by alation_db_user:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">MY_SCHEMA</span><span class="p">.</span><span class="n">QRYLOG_FULL</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="a-3-amazon-redshift-query-log-table">
<span id="appendix-3"></span><h2>A.3 Amazon Redshift Query Log Table<a class="headerlink" href="#a-3-amazon-redshift-query-log-table" title="Permalink to this headline">¶</a></h2>
<p>Automated daily Query Log Ingestion of Amazon Redshift queries requires an ETL
to maintain a rolling Query Log having queries executed in the last
3 days. If Query Log table is small then we recommend maintaining
queries for a longer period like the last seven days.</p>
<p>This needs to be a table, not a view, to allow the Alation user
to see queries created by other people. If the Alation user queried the
view, it would only see its own queries; if a process with full access
to everyone’s queries creates and updates a table the Alation user
queries, the Alation user can see all the queries in that table.</p>
<p>The following two queries can be used to create a rolling query log. The
sample queries use public.alation_qlog as the Query Log table however the
table can be named anything and can be placed in any schema as long as
Alation DB account has SELECT, INSERT, and DELETE privileges to the
table.</p>
<ol class="arabic">
<li><p>Delete queries older than last three days.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">PUBLIC</span><span class="p">.</span><span class="n">ALATION_QLOG</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">START_TIME</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;3 days&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>Append queries executed in the last 24 hours to the Query Log. The following query needs to run as an admin user else the Query Log will not have queries by all users.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">querytxt</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">aborted</span>
<span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;ABORTED&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">canceled</span><span class="p">,</span>
<span class="w">    </span><span class="n">datediff</span><span class="w"> </span><span class="p">(</span><span class="n">millisecond</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">endtime</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seconds_taken</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">cast</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">process</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">to_char</span>
<span class="w">        </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;YYYY-MM-DD HH:MI:SS.US&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">sequence</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seq</span><span class="p">,</span>
<span class="w">    </span><span class="k">trim</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">db_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">default_database</span><span class="p">,</span>
<span class="w">    </span><span class="k">trim</span><span class="w"> </span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">query_filename</span><span class="p">,</span>
<span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">qtype</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span>
<span class="w">    </span><span class="k">INTO</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qlog</span>
<span class="w">  </span><span class="k">FROM</span>
<span class="w">    </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">          </span><span class="k">SELECT</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">userid</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">query</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">label</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span>
<span class="w">            </span><span class="k">DATABASE</span><span class="p">,</span>
<span class="w">            </span><span class="n">qt</span><span class="p">.</span><span class="nb">text</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">querytxt</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">endtime</span><span class="p">,</span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">aborted</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;QUERY&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span><span class="p">,</span>
<span class="w">            </span><span class="n">qt</span><span class="p">.</span><span class="n">sequence</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;sequence&quot;</span>
<span class="w">          </span><span class="k">FROM</span>
<span class="w">            </span><span class="n">stl_query</span><span class="w"> </span><span class="n">q</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">stl_querytext</span><span class="w"> </span><span class="n">qt</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">query</span>
<span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">xid</span>
<span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">pid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">query_combined</span>
<span class="w">      </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">      </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">userid</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">query</span><span class="p">,</span>
<span class="w">        </span><span class="n">label</span><span class="p">,</span>
<span class="w">        </span><span class="n">xid</span><span class="p">,</span>
<span class="w">        </span><span class="n">pid</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">DATABASE</span><span class="p">,</span>
<span class="w">        </span><span class="nb">text</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">querytxt</span><span class="p">,</span>
<span class="w">        </span><span class="n">starttime</span><span class="p">,</span>
<span class="w">        </span><span class="n">endtime</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">aborted</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;DDL&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;sequence&quot;</span>
<span class="w">      </span><span class="k">FROM</span>
<span class="w">        </span><span class="n">stl_ddltext</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">q</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">stl_sessions</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">process</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">userid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">userid</span>
<span class="w">  </span><span class="k">WHERE</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;rdsdb&#39;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">starttime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">LOCALTIMESTAMP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;3 day&#39;</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<section id="alternative-sql-does-not-automatically-create-table">
<h3>Alternative SQL (does not automatically create table)<a class="headerlink" href="#alternative-sql-does-not-automatically-create-table" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span>
<span class="w">  </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qlog</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">querytxt</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span>
<span class="w">      </span><span class="k">CASE</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">aborted</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;ABORTED&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">canceled</span><span class="p">,</span>
<span class="w">      </span><span class="n">datediff</span><span class="p">(</span><span class="n">millisecond</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">endtime</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seconds_taken</span><span class="p">,</span>
<span class="w">      </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">      </span><span class="k">cast</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">process</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">to_char</span>
<span class="w">        </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;YYYY-MM-DD HH:MI:SS.US&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">sequence</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seq</span><span class="p">,</span>
<span class="w">      </span><span class="k">trim</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">db_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">default_database</span><span class="p">,</span>
<span class="w">      </span><span class="k">trim</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">query_filename</span><span class="p">,</span>
<span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">qtype</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span>
<span class="w">    </span><span class="k">FROM</span>
<span class="w">      </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span>
<span class="w">          </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">userid</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">query</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">label</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span>
<span class="w">              </span><span class="k">DATABASE</span><span class="p">,</span>
<span class="w">              </span><span class="n">qt</span><span class="p">.</span><span class="nb">text</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">querytxt</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">endtime</span><span class="p">,</span>
<span class="w">              </span><span class="n">q</span><span class="p">.</span><span class="n">aborted</span><span class="p">,</span>
<span class="w">              </span><span class="s1">&#39;QUERY&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span><span class="p">,</span>
<span class="w">              </span><span class="n">qt</span><span class="p">.</span><span class="n">sequence</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;sequence&quot;</span>
<span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">stl_query</span><span class="w"> </span><span class="n">q</span>
<span class="w">              </span><span class="k">JOIN</span><span class="w"> </span><span class="n">stl_querytext</span><span class="w"> </span><span class="n">qt</span>
<span class="w">                  </span><span class="k">ON</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">query</span>
<span class="w">                  </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">xid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">xid</span>
<span class="w">                  </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt</span><span class="p">.</span><span class="n">pid</span>
<span class="w">          </span><span class="p">)</span><span class="w"> </span><span class="n">query_combined</span>
<span class="w">        </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">        </span><span class="k">SELECT</span>
<span class="w">          </span><span class="n">userid</span><span class="p">,</span>
<span class="w">          </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">query</span><span class="p">,</span>
<span class="w">          </span><span class="n">label</span><span class="p">,</span>
<span class="w">          </span><span class="n">xid</span><span class="p">,</span>
<span class="w">          </span><span class="n">pid</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">DATABASE</span><span class="p">,</span>
<span class="w">          </span><span class="nb">text</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">querytxt</span><span class="p">,</span>
<span class="w">          </span><span class="n">starttime</span><span class="p">,</span>
<span class="w">          </span><span class="n">endtime</span><span class="p">,</span>
<span class="w">          </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">aborted</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;DDL&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtype</span><span class="p">,</span>
<span class="w">          </span><span class="ss">&quot;sequence&quot;</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">stl_ddltext</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">q</span>
<span class="w">      </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">stl_sessions</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">process</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">userid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">userid</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">starttime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">starttime</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">endtime</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">endtime</span>
<span class="w">    </span><span class="k">WHERE</span>
<span class="w">      </span><span class="n">s</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;rdsdb&#39;</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">starttime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">localtimestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 day&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="a-4-oracle-query-log-view">
<span id="appendix-4"></span><h2>A.4 Oracle Query Log View<a class="headerlink" href="#a-4-oracle-query-log-view" title="Permalink to this headline">¶</a></h2>
<section id="oracle-qli-view-using-ash-table">
<h3>Oracle QLI View using ASH table<a class="headerlink" href="#oracle-qli-view-using-ash-table" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span>
<span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="o">&lt;</span><span class="k">schema</span><span class="o">&gt;</span><span class="p">.</span><span class="n">alation_query_log_view</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">begin_interval_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">dbid</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">snap_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">session_id</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">session_serial</span><span class="o">#</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">instance_number</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">instance_number</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">sql_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">sample_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">service_hash</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">client_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">machine</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">command_type</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">sql_text</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">start_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">cpu_time_ms</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">time_ms</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">db_time_ms</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">time2_ms</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">read_io_requests</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">write_io_requests</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">read_io_bytes</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">write_io_bytes</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">interconnect_io_bytes</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">max_pga_mem</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">max_temp_space</span><span class="p">,</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">machine</span><span class="w"> </span><span class="o">||</span><span class="s1">&#39;:&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">port</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">returncode</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">process_id</span><span class="p">,</span>
<span class="w">  </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_start_time</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">      </span><span class="n">s</span><span class="p">.</span><span class="n">begin_interval_time</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">DBID</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">snap_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">session_serial</span><span class="o">#</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">sql_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">sample_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">service_hash</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">client_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">machine</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">instance_number</span><span class="p">,</span>
<span class="w">      </span><span class="k">MIN</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">sample_time</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">tm_delta_cpu_time</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cpu_time_ms</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">tm_delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">time_ms</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">tm_delta_db_time</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">db_time_ms</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">time2_ms</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_read_io_requests</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">read_io_requests</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_write_io_requests</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">write_io_requests</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_read_io_bytes</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">read_io_bytes</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_write_io_bytes</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">write_io_bytes</span><span class="p">,</span>
<span class="w">      </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">delta_interconnect_io_bytes</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">interconnect_io_bytes</span><span class="p">,</span>
<span class="w">      </span><span class="k">MAX</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">pga_allocated</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_pga_mem</span><span class="p">,</span>
<span class="w">      </span><span class="k">MAX</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">temp_space_allocated</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_temp_space</span>
<span class="w">    </span><span class="k">FROM</span>
<span class="w">      </span><span class="n">dba_hist_active_sess_history</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dba_hist_snapshot</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">dbid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">dbid</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">snap_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">snap_id</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">instance_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">instance_number</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">dbid</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">snap_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">session_serial</span><span class="o">#</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">sql_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">sample_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">service_hash</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">client_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">machine</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
<span class="w">      </span><span class="n">s</span><span class="p">.</span><span class="n">begin_interval_time</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">instance_number</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">r</span>
<span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dba_users</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">user_id</span>
<span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dba_hist_sqltext</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">dbid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">dbid</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">sql_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">sql_id</span>
<span class="k">WHERE</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">command_type</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="cm">/* system cmds */</span>
<span class="w">    </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="cm">/* declare cmd */</span>
<span class="w">    </span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">189</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;SYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;OLAPSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;LBACSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;OWBSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;OWBSYS_AUDIT&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;APPQOSSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;SYSMAN&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;WMSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;EXFSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;CTXSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;ORDSYS&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;MDSYS&#39;</span>
<span class="w">  </span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="a-5-vertica-query-log">
<h2>A.5 Vertica Query Log<a class="headerlink" href="#a-5-vertica-query-log" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- SQL to create the query log table that Alation will read from. Drop is only require</span>
<span class="c1">-- You can choose any name for the table and any name for ‘alation_app’</span>
<span class="c1">-- You will enter these names in the Alation UI to configure Query Ingestion</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qrylog_table</span><span class="p">;</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qrylog_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">  </span><span class="n">user_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">  </span><span class="n">start_timestamp</span><span class="w"> </span><span class="n">timestamptz</span><span class="p">,</span>
<span class="w">  </span><span class="n">end_timestamp</span><span class="w"> </span><span class="n">timestamptz</span><span class="p">,</span>
<span class="w">  </span><span class="n">request_duration_ms</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
<span class="w">  </span><span class="n">request_id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
<span class="w">  </span><span class="n">request</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64000</span><span class="p">),</span>
<span class="w">  </span><span class="n">canceled</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
<span class="w">  </span><span class="n">search_path</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64000</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qrylog_table</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">alation_app</span><span class="p">;</span>
<span class="w">  </span><span class="c1">-- You can use this query to check the current size given to the Requests Issued</span>
<span class="w">  </span><span class="c1">-- collector. You may need to increase the size if your query volume is high because</span>
<span class="w">  </span><span class="c1">-- the queries may be gone by the time the ETL runs to copy them over to the alation</span>
<span class="w">  </span><span class="c1">-- table. The ETL copies the previous days queries over so you need at least enough</span>
<span class="w">  </span><span class="c1">-- to store two days worth of queries.</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">V_MONITOR</span><span class="p">.</span><span class="n">DATA_COLLECTOR</span>
<span class="w">  </span><span class="k">WHERE</span>
<span class="w">    </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RequestsIssued&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="c1">-- ETL SQL to move queries from Vertica system tables to the Alation query log table.</span>
<span class="w">  </span><span class="c1">-- Run this query every day, preferably towards the end of the data in case</span>
<span class="w">  </span><span class="c1">-- any queries from the previous day are still running.</span>
<span class="w">  </span><span class="c1">-- Alation ingests the day two days behind the current date so as long as the ETL is done</span>
<span class="w">  </span><span class="c1">-- by then Alation will not miss any queries.</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span>
<span class="w">  </span><span class="n">alation_qrylog_table</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">      </span><span class="n">ri</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">ri</span><span class="p">.</span><span class="n">user_name</span><span class="p">,</span>
<span class="w">      </span><span class="n">qr</span><span class="p">.</span><span class="n">start_timestamp</span><span class="p">,</span>
<span class="w">      </span><span class="n">qr</span><span class="p">.</span><span class="n">end_timestamp</span><span class="p">,</span>
<span class="w">      </span><span class="n">qr</span><span class="p">.</span><span class="n">request_duration_ms</span><span class="p">,</span>
<span class="w">      </span><span class="n">ri</span><span class="p">.</span><span class="n">request_id</span><span class="p">,</span>
<span class="w">      </span><span class="n">ri</span><span class="p">.</span><span class="n">request</span><span class="p">,</span>
<span class="w">      </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">qr</span><span class="p">.</span><span class="n">success</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;FAILED&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">canceled</span><span class="p">,</span>
<span class="w">      </span><span class="n">qr</span><span class="p">.</span><span class="n">search_path</span>
<span class="w">    </span><span class="k">FROM</span>
<span class="w">      </span><span class="n">v_internal</span><span class="p">.</span><span class="n">dc_requests_issued</span><span class="w"> </span><span class="n">ri</span>
<span class="w">      </span><span class="k">JOIN</span><span class="w"> </span><span class="n">v_monitor</span><span class="p">.</span><span class="n">query_requests</span><span class="w"> </span><span class="n">qr</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="n">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qr</span><span class="p">.</span><span class="n">transaction_id</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="n">request_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qr</span><span class="p">.</span><span class="n">request_id</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qr</span><span class="p">.</span><span class="n">session_id</span>
<span class="w">    </span><span class="k">WHERE</span>
<span class="w">      </span><span class="nb">date</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">and</span><span class="w"> </span><span class="nb">date</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">alation_querylog</span><span class="p">;</span>
<span class="w">  </span><span class="c1">-- Optional ETL to delete rows from the query log table to save space.</span>
<span class="w">  </span><span class="c1">-- If Alation auto ingestion is enabled it will continually ingest the queries from this</span>
<span class="w">  </span><span class="c1">-- table each day. It may lag a few days behind the current date so it is safe to delete</span>
<span class="w">  </span><span class="c1">-- rows older than a week.</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span>
<span class="w">  </span><span class="k">public</span><span class="p">.</span><span class="n">alation_qrylog_table</span>
<span class="k">WHERE</span>
<span class="w">  </span><span class="nb">date</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="a-6-netezza-query-log-view">
<h2>A.6 Netezza Query Log View<a class="headerlink" href="#a-6-netezza-query-log-view" title="Permalink to this headline">¶</a></h2>
<p>Netezza supports Query History version 2 and Query History version 3.
Alation does not support Query History version 1.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Description</p></th>
<th class="head"><p>Query History version 2</p></th>
<th class="head"><p>Query History version 3</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Netezza Release</p></td>
<td><p>IBM® Netezza® release</p></td>
<td><p>In release 7.1, the</p></td>
</tr>
<tr class="row-odd"><td><p>version</p></td>
<td><p>7.0.3 introduces a
new version of the
history database to
support schema in the
Netezza database.</p></td>
<td><p>query history
configuration version
is incremented from 2
to 3.</p></td>
</tr>
</tbody>
</table>
<p>The parameters <code class="docutils literal notranslate"><span class="pre">{query_prolog}</span></code>, <code class="docutils literal notranslate"><span class="pre">{query_epilog}</span></code>, and <code class="docutils literal notranslate"><span class="pre">{session_prolog}</span></code> will be
replaced in the query as listed in the following table.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 41%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>History Version 2 view</p></th>
<th class="head"><p>History Version 3 view</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">{query_prolog}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_query_prolog_2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_query_prolog_3&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">{query_epilog}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_query_epilog_2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_query_epilog_3&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">{session_prolog}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_session_prolog_2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hist.TEST_HISTORY_OWNER.&quot;$hist_session_prolog_3&quot;</span></code></p></td>
</tr>
</tbody>
</table>
<p>Follow the steps as listed to view the query log for Netezza.</p>
<ol class="arabic">
<li><p>Log in to the system database as an admin user.</p></li>
<li><p>Create query history load user (optional user):</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">test_history_load</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="3">
<li><p>Create query history owner user or a mandatory user.  If the history load user is not created, it is a load user:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">test_history_owner</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant Create Database to test_history_owner:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">test_history_owner</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant List on test_history_load to USER test_history_owner if it is used as load user:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="n">LIST</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">test_history_load</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">test_history_owner</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Create a history database:</p>
<blockquote>
<div><div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>nzhistcreatedb<span class="w"> </span>-d<span class="w"> </span>hist<span class="w"> </span>-n<span class="w"> </span>netezza.alation.internal<span class="w"> </span>-t<span class="w"> </span>Q<span class="w"> </span>-o<span class="w"> </span>test_history_owner<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-u<span class="w"> </span>test_history_load<span class="w"> </span>-v<span class="w"> </span><span class="o">{</span>version<span class="o">}</span>
</pre></div>
</div>
<p>Replace the value of <code class="docutils literal notranslate"><span class="pre">{version}</span></code> with <strong>2</strong> for History Version 2 and <strong>3</strong> for History Version 3.</p>
</div></blockquote>
</li>
<li><p>Create query history configuration based on database. Replace the value of <code class="docutils literal notranslate"><span class="pre">{configuration</span> <span class="pre">name}</span></code> of <code class="docutils literal notranslate"><span class="pre">test_hist_v2</span></code> for History Version 2 and a value of <code class="docutils literal notranslate"><span class="pre">test_hist_v3</span></code> for History Version 3.</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">CREATE HISTORY CONFIGURATION {configuration name} HISTTYPE QUERY</span>
<span class="go">DATABASE hist USER test_history_owner PASSWORD &#39;password&#39; COLLECT QUERY</span>
<span class="go">LOADINTERVAL 0 LOADMINTHRESHOLD 0 LOADMAXTHRESHOLD 20</span>
<span class="go">STORAGELIMIT 40 LOADRETRY 2 VERSION {version};</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Set Query History configuration.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">SET HISTORY CONFIGURATION {configuration name}</span>
</pre></div>
</div>
</li>
<li><p>Stop Netezza</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>nzstop
</pre></div>
</div>
</li>
<li><p>Start Netezza</p></li>
</ol>
<blockquote>
<div><div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>nzstart
</pre></div>
</div>
</div></blockquote>
<ol class="arabic" start="11">
<li><p>Log in database <code class="docutils literal notranslate"><span class="pre">hist</span></code> with <code class="docutils literal notranslate"><span class="pre">test_history_owner</span></code></p></li>
<li><p>Create a schema and view for Query Log Ingestion (QLI).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">CREATE SCHEMA netezza_test_query_log_sch;</span>
<span class="go">CREATE VIEW netezza_test_query_log_sch.netezza_test_query_log AS SELECT</span>
<span class="go">  qp.opid,</span>
<span class="go">  sp.connecttime,</span>
<span class="go">  qe.npsid,</span>
<span class="go">  qe.npsinstanceid,</span>
<span class="go">  qe.sessionid,</span>
<span class="go">  qe.resultrows,</span>
<span class="go">  qe.status,</span>
<span class="go">  qe.finishtime,</span>
<span class="go">  qp.userid,</span>
<span class="go">  qp.username,</span>
<span class="go">  qp.submittime,</span>
<span class="go">  qp.querytext,</span>
<span class="go">  qp.dbname,</span>
<span class="go">  qp.dbid,</span>
<span class="go">  qp.schemaid,</span>
<span class="go">  qp.schemaname,</span>
<span class="go">  date_part (&#39;epoch&#39;, finishtime - submittime) AS runtime_seconds</span>
<span class="go">FROM</span>
<span class="go">  {query_prolog} qp</span>
<span class="go">  JOIN {query_epilog} qe ON qp.opid = qe.opid</span>
<span class="go">    AND qp.npsid = qe.npsid</span>
<span class="go">    AND qp.npsinstanceid = qe.npsinstanceid</span>
<span class="go">    AND qp.sessionid = qe.sessionid</span>
<span class="go">  JOIN {session_prolog} sp ON sp.npsid = qe.npsid</span>
<span class="go">    AND sp.npsinstanceid = qe.npsinstanceid</span>
<span class="go">    AND sp.sessionid = qe.sessionid</span>
<span class="go">    AND qp.querytext not in (</span>
<span class="go">      &#39;commit&#39;, &#39;COMMIT&#39;,</span>
<span class="go">      &#39;begin&#39;, &#39;BEGIN&#39;,</span>
<span class="go">      &#39;select current_catalog’, ‘current_schema’, ‘current_user&#39;,</span>
<span class="go">      &#39;select identifier_case’, ‘current_catalog’, ‘current_user&#39;,</span>
<span class="go">      &#39;select db_encoding&#39;, &#39;select nchar_encoding&#39;</span>
<span class="go">  )</span>
<span class="go">  AND qp.querytext not like &#39;select version()%&#39;</span>
<span class="go">  AND qp.querytext not like &#39;set client_version%&#39;</span>
<span class="go">  AND qp.querytext not like &#39;SET CLIENT_VERSION%&#39;</span>
<span class="go">  AND qp.querytext not like &#39;set nz_encoding%&#39;</span>
<span class="go">  AND qp.querytext not like &#39;set datestyle %&#39;</span>
<span class="go">  AND qp.querytext not like &#39;set DateStyle %&#39;</span>
<span class="go">  AND qp.querytext not like &#39;SET timezone %&#39;</span>
<span class="go">  AND qp.querytext not like &#39;SET TRANSACTION %&#39;</span>
<span class="go">  AND qp.querytext not like &#39;%JDBC Client Version%&#39;;</span>
</pre></div>
</div>
</li>
<li><p>Result query validation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">netezza_test_query_log_sch</span><span class="p">.</span><span class="n">netezza_test_query_log</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
<p>The validation result should not be zero.</p>
<ol class="arabic" start="14">
<li><p>Connect to the system database as an admin and grant permission to &lt;alation_service_account&gt;:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="n">LIST</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alation_service_account</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">test_history_owner</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">ON</span><span class="w">  </span><span class="o">&lt;</span><span class="n">alation_service_account</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">test_history_owner</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Connect to <code class="docutils literal notranslate"><span class="pre">hist</span></code> database using <code class="docutils literal notranslate"><span class="pre">test_history_owner</span></code> user and give permission to &lt;alation_service_account&gt; to run <code class="docutils literal notranslate"><span class="pre">hist.netezza_test_query_log_sch.netezza_test_query_log</span></code> view:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w">  </span><span class="n">hist</span><span class="p">.</span><span class="n">netezza_test_query_log_sch</span><span class="p">.</span><span class="n">netezza_test_query_log</span>
<span class="k">TO</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alation_service_account</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Connect to system database using extraction user <code class="docutils literal notranslate"><span class="pre">&lt;alation_service_account&gt;</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">hist</span><span class="p">.</span><span class="n">netezza_test_query_log_sch</span><span class="p">.</span><span class="n">netezza_test_query_log</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Verify results. The validation result should not be zero.</p></li>
</ol>
<section id="how-do-you-capture-history-for-a-particular-database">
<h3>How do you capture history for a particular database?<a class="headerlink" href="#how-do-you-capture-history-for-a-particular-database" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ALTER DATABASE &lt;db_name&gt; COLLECT HISTORY {ON  DEFAULT}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description of value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>COLLECT HISTORY</p></td>
<td><p>Creation of a database: Collection of history for session attached to the database.</p>
<p>If the value is set to ON, history is collected only if the user is a
member of at least one group. The COLLECT HISTORY is set to ON and is
the default value.
If the value is set to OFF, history is not collected for the database.</p>
<p>If the value is set to DEFAULT, history is collected for the database
only if the user is a member of at least one group. The COLLECT HISTORY
is set to ON and one of the following criteria apply:</p>
<ul class="simple">
<li><p>The user is not a member of any group.</p></li>
<li><p>All the user groups of which the user is a member and the COLLECT HISTORY is set to DEFAULT.</p></li>
<li><p>The user is a member of at least one user group and COLLECT HISTORY is set to ON.</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
<section id="how-do-you-capture-history-for-a-particular-user-group-group-name">
<h3>How do you capture history for a particular user group &lt;group_name&gt; ?<a class="headerlink" href="#how-do-you-capture-history-for-a-particular-user-group-group-name" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ALTER GROUP &lt;group_name&gt; WITH COLLECT HISTORY {ONDEFAULT}</span>
</pre></div>
</div>
</section>
<section id="how-to-add-a-particular-user-user-name-to-group-group-name-for-which-collect-history-is-on-or-default">
<h3>How to add a particular user &lt;user_name&gt; to group &lt;group_name&gt; for which <code class="docutils literal notranslate"><span class="pre">COLLECT</span> <span class="pre">HISTORY</span></code> is <code class="docutils literal notranslate"><span class="pre">ON</span></code> or <code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code>?<a class="headerlink" href="#how-to-add-a-particular-user-user-name-to-group-group-name-for-which-collect-history-is-on-or-default" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="o">&lt;</span><span class="n">group_name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="o">&lt;</span><span class="n">user_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description of value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>COLLECT HISTORY</p></td>
<td><p>If the system should collect history of data for the session of a user who is a member of the
group:</p>
<p>If the value is set to ON, history is collected only if the user is
connected to a database and the COLLECT HISTORY is set to ON.</p>
<p>If the value is set to OFF, history is not collected for the database.</p>
<p>If the value is set to DEFAULT, history is collected for the user only if
the user is connected to a database and the COLLECT HISTORY is set to ON
and one of the following criteria apply:</p>
<ul class="simple">
<li><p>The user is not a member of any group.</p></li>
<li><p>All the user groups of which the user is a member and the  COLLECT HISTORY is set to DEFAULT.</p></li>
<li><p>The user is a member of at least one user group and COLLECT HISTORY is set to ON.</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="a-7-postgres-qli-setup">
<span id="appendix-7"></span><h2>A.7 Postgres QLI Setup<a class="headerlink" href="#a-7-postgres-qli-setup" title="Permalink to this headline">¶</a></h2>
<section id="csv-logging-with-no-log-rotation">
<h3>CSV Logging with No Log Rotation<a class="headerlink" href="#csv-logging-with-no-log-rotation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>First you need to change the server configuration (<strong>postgresql.conf</strong>) and enable CSV logging as described in detail here and reload.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set in postgresql.conf + restart/reload server (changing logging_collector needs a restart)</span>

<span class="nv">log_destination</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;csvlog&#39;</span>

<span class="nv">log_directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pg_log&#39;</span>

<span class="nv">logging_collector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="nv">log_filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;postgresql&#39;</span>

<span class="nv">log_min_duration_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="nv">log_error_verbosity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>verbose<span class="w">      </span><span class="c1"># terse, default, or verbose messages</span>

<span class="nv">log_hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="nv">log_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">      </span><span class="c1"># none, ddl, mod, all</span>

<span class="nv">log_rotation_age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="nv">log_rotation_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="nv">log_min_error_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>info
</pre></div>
</div>
<p>Reload the updated <strong>postgressql.conf</strong> as follows:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_reload_conf</span><span class="p">();</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">log_rotation_age</span> <span class="pre">=</span> <span class="pre">0</span></code> and  <code class="docutils literal notranslate"><span class="pre">log_rotation_size</span> <span class="pre">=</span> <span class="pre">0</span></code> to stop rotation and all logs will be written to the same file, that is to the same table. The difference between setting this option and setting <code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code> to zero is that exceeding  <code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code> forces the text of the query to be logged, but <code class="docutils literal notranslate"><span class="pre">log_duration</span></code> doesn’t.</p>
</div>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>Install the <code class="docutils literal notranslate"><span class="pre">file_fdw</span></code> extension (<code class="docutils literal notranslate"><span class="pre">contrib</span></code> package needed) and create a foreign file server and a foreign table, linking to our above configured log file name.</p>
<blockquote>
<div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">Postgres 14.1</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Postgres 13</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">backend_type</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">empty_column</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">column_with_zeroes</span><span class="w"> </span><span class="nb">text</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span>
<span class="w">    </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="s1">&#39;pg_log/postgresql.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">backend_type</span><span class="w"> </span><span class="nb">text</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span>
<span class="w">    </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="s1">&#39;pg_log/postgresql.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
</div></blockquote>
</li>
<li><p>Create a View</p></li>
</ol>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_postgres_logv</span><span class="w"> </span><span class="k">as</span>
<span class="w">  </span><span class="k">SELECT</span>
<span class="w">  </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="p">,</span>
<span class="w">  </span><span class="n">log_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">postgres_log</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Grant access to Alation Service Account:</p></li>
</ol>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Grant SELECT on public.alation_postgres_logv to {Alation Service Account}</span>
</pre></div>
</div>
</div></blockquote>
<section id="update-general-settings-in-alation-ui">
<h4>Update General Settings in Alation UI<a class="headerlink" href="#update-general-settings-in-alation-ui" title="Permalink to this headline">¶</a></h4>
<p>Enter the view name <code class="docutils literal notranslate"><span class="pre">public.alation_postgres_logv</span></code> in the Query Log Privileges entry box.</p>
<p>Leave <strong>Use EDB Audit Logs for Profiling</strong> checkbox unselected.</p>
<a class="reference internal image-reference" href="../../_images/unselectUseAuditLogsForProfiling.png"><img alt="../../_images/unselectUseAuditLogsForProfiling.png" class="align-center" src="../../_images/unselectUseAuditLogsForProfiling.png" style="width: 5.5in;" /></a>
</section>
</section>
<section id="csv-logging-with-log-rotation">
<h3>CSV Logging with Log rotation<a class="headerlink" href="#csv-logging-with-log-rotation" title="Permalink to this headline">¶</a></h3>
<p>A handy way to expose and physically keep around (automatic truncation)
only seven days of logs is to define seven child tables for a master one.
Process would then look something like this:</p>
<ol class="arabic simple">
<li><p>set in <strong>postgresql.conf</strong> + reload conf</p></li>
</ol>
<blockquote>
<div><div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="nv">log_destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;csvlog&#39;</span>

<span class="nv">log_filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;postgresql-%a&#39;</span><span class="w">  </span><span class="c1"># Keep 7d of logs in files &#39;postgresql-Mon.csv&#39; etc.</span>

<span class="nv">log_directory</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;pg_log&#39;</span>

<span class="nv">logging_collector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="nv">log_min_duration_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="nv">log_error_verbosity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>verbose<span class="w">     </span><span class="c1"># terse, default, or verbose messages</span>

<span class="nv">log_hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="nv">log_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">    </span><span class="c1"># none, ddl, mod, all</span>

<span class="nv">log_truncate_on_rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="nv">log_rotation_age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1440</span>

<span class="nv">log_rotation_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="nv">log_min_error_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>info
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To keep seven days of logs, one log file per day named <code class="docutils literal notranslate"><span class="pre">postgresql-Mon</span></code>, <code class="docutils literal notranslate"><span class="pre">postgresql-Tue</span></code>, etc. and automatically overwrite last week’s log with this week’s log, set <code class="docutils literal notranslate"><span class="pre">log_filename</span></code> to <code class="docutils literal notranslate"><span class="pre">postgresql-%a</span></code>, <code class="docutils literal notranslate"><span class="pre">log_truncate_on_rotation</span></code> to <code class="docutils literal notranslate"><span class="pre">on</span></code>, and <code class="docutils literal notranslate"><span class="pre">log_rotation_age</span></code> to <code class="docutils literal notranslate"><span class="pre">1440</span></code>.</p>
</div>
<p>The difference between setting this option and setting <code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code> to zero is that exceeding <code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code> forces the text of the query to be logged, but <code class="docutils literal notranslate"><span class="pre">log_duration</span></code> doesn’t.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Install the <code class="docutils literal notranslate"><span class="pre">file_fdw</span></code> extension (<code class="docutils literal notranslate"><span class="pre">contrib</span></code> package needed) and create a foreign file server and a foreign table, linking to our above configured log file name.</p></li>
</ol>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log_mon</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">    </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span>
<span class="w">        </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="s1">&#39;pg_log/postgresql-Mon.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="p">);</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log_mon</span><span class="w"> </span><span class="n">INHERIT</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>Repeat for Tue…Sun</p></li>
<li><p>Create a View</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_postgres_logv</span><span class="w"> </span><span class="k">as</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="p">,</span>
<span class="w">  </span><span class="n">log_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">postgres_log</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant access to Alation Service Account</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Grant SELECT on public.alation_postgres_logv to {Alation Service Account}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Update General Settings in Alation UI</p>
<blockquote>
<div><p>Have an Alation Admin for your instance configure the General Settings
from the Alation UI to point to the created
view <code class="docutils literal notranslate"><span class="pre">public.alation_postgres_logv</span></code>.</p>
<p>Leave <strong>Use EDB Audit Logs for Profiling</strong> checkbox unselected.</p>
<a class="reference internal image-reference" href="../../_images/unselectUseAuditLogsForProfiling(1).png"><img alt="../../_images/unselectUseAuditLogsForProfiling(1).png" class="align-center" src="../../_images/unselectUseAuditLogsForProfiling(1).png" style="width: 5.5in;" /></a>
</div></blockquote>
</li>
</ol>
</section>
<section id="edb-audit-logs-with-no-log-rotation">
<h3>EDB Audit logs with No Log Rotation<a class="headerlink" href="#edb-audit-logs-with-no-log-rotation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>First you need to change the server configuration (postgresql.conf) and enable CSV logging as described in detail here and reload.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set in postgresql.conf + restart/reload server (changing logging_collector needs restart)</span>
<span class="c1">#------------------------------------------------------------</span>
<span class="c1"># ERROR REPORTING AND LOGGING</span>
<span class="c1">#------------------------------------------------------------</span>

<span class="c1"># - Where to Log -</span>

<span class="nv">logging_collector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on

<span class="c1">#------------------------------------------------------------</span>
<span class="c1"># EDB AUDIT</span>
<span class="c1">#------------------------------------------------------------</span>

<span class="nv">edb_audit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="w">                       </span><span class="c1"># none, csv or xml</span>

<span class="c1"># These are only used if edb_audit is not none:</span>
<span class="nv">edb_audit_directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;edb_audit&#39;</span><span class="w">       </span><span class="c1"># Directory where the log files are written</span>
<span class="w">                                        </span><span class="c1"># Can be absolute or relative to PGDATA</span>

<span class="nv">edb_audit_filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;postgresaudit&#39;</span><span class="w">    </span><span class="c1"># Audit file name pattern.</span>
<span class="w">                                        </span><span class="c1"># Can include strftime() escapes</span>

<span class="nv">edb_audit_rotation_day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="w">         </span><span class="c1"># Automatic rotation of log files based</span>
<span class="w">                                        </span><span class="c1"># on day of week. none, every, sun,</span>
<span class="w">                                        </span><span class="c1"># mon, tue, wed, thu, fri, sat</span>

<span class="nv">edb_audit_rotation_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">             </span><span class="c1"># Automatic rotation of log files will</span>
<span class="w">                                        </span><span class="c1"># happen after this many megabytes (MB)</span>
<span class="w">                                        </span><span class="c1"># of log output.  0 to disable.</span>

<span class="nv">edb_audit_rotation_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">          </span><span class="c1"># Automatic log file rotation will</span>
<span class="w">                                        </span><span class="c1"># happen after this many seconds.</span>

<span class="nv">edb_audit_connect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">               </span><span class="c1"># none, failed, all</span>

<span class="c1">#edb_audit_disconnect =&#39;none&#39;           # none, all</span>

<span class="nv">edb_audit_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">             </span><span class="c1"># none, dml, ddl, select, error, rollback, all</span>

<span class="c1">#edb_audit_tag = &#39;&#39;</span>
</pre></div>
</div>
<p>Reload the updated <strong>postgressql.conf</strong> using the following command:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_reload_conf</span><span class="p">();</span>
</pre></div>
</div>
<p>Note: <code class="docutils literal notranslate"><span class="pre">edb_audit_rotation_size</span> <span class="pre">=</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">edb_audit_rotation_day</span> <span class="pre">=</span> <span class="pre">'none'</span></code>  and <code class="docutils literal notranslate"><span class="pre">edb_audit_rotation_seconds</span> <span class="pre">=</span> <span class="pre">0</span></code> to stop rotation and all logs will be written to the same file, that is, to same table.</p>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>Install the <code class="docutils literal notranslate"><span class="pre">file_fdw</span></code> extension (<code class="docutils literal notranslate"><span class="pre">contrib</span></code> package needed) and create a foreign file server and a foreign table, linking to our above configured log file name.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">file_fdw</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">extra</span><span class="w"> </span><span class="nb">text</span>
<span class="p">)</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">pglog</span>
<span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">filename</span><span class="w"> </span><span class="s1">&#39;edb_audit/postgresaudit.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Create a View</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_postgres_logv</span><span class="w"> </span><span class="k">as</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="p">,</span>
<span class="w">  </span><span class="n">log_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">postgres_log</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant access to Alation Service Account</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Grant SELECT on public.alation_postgres_logv to {Alation Service Account}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Update General Settings in Alation UI</p>
<blockquote>
<div><p>Enter the view <code class="docutils literal notranslate"><span class="pre">namepublic.alation_postgres_logv</span></code> in text entry box.</p>
<p>Select <strong>Use EDB Audit Logs for Profiling</strong> checkbox:</p>
<a class="reference internal image-reference" href="../../_images/selectUseAuditLogsForProfiling.png"><img alt="../../_images/selectUseAuditLogsForProfiling.png" class="align-center" src="../../_images/selectUseAuditLogsForProfiling.png" style="width: 5.5in;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This log doesn’t log duration.</p>
</div>
</div></blockquote>
</li>
</ol>
</section>
<section id="edb-postgres-server-with-audit-log-rotation">
<h3>EDB Postgres Server with Audit Log Rotation<a class="headerlink" href="#edb-postgres-server-with-audit-log-rotation" title="Permalink to this headline">¶</a></h3>
<p>(Alation version 4.16)</p>
<ol class="arabic simple">
<li><p>First you need to change the server configuration (postgresql.conf) and enable CSV logging as described in detail here and reload.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set in postgresql.conf + restart/reload server (changing logging_collector needs restart)</span>
<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="c1">#ERROR REPORTING AND LOGGING</span>
<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="c1"># - Where to Log -</span>
<span class="nv">logging_collector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>on
<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="c1"># EDB AUDIT</span>
<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="nv">edb_audit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;csv&#39;</span><span class="w">                                   </span><span class="c1"># none, csv or xml</span>

<span class="c1"># These are only used if edb_audit is not none:</span>

<span class="nv">edb_audit_directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;edb_audit&#39;</span><span class="w">                  </span><span class="c1"># Directory where the log files are written</span>
<span class="w">                                                   </span><span class="c1"># Can be absolute or relative to PGDATA</span>

<span class="nv">edb_audit_filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;audit-%Y-%m-%dT%H:%M:%S&#39;</span><span class="w">      </span><span class="c1"># Audit file name pattern.</span>
<span class="w">                                                    </span><span class="c1"># Can include strftime() escapes</span>

<span class="nv">edb_audit_rotation_day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;every&#39;</span><span class="w">                    </span><span class="c1"># Automatic rotation of log files based</span>
<span class="w">                                                    </span><span class="c1"># on day of week. none, every, sun,</span>
<span class="w">                                                    </span><span class="c1"># mon, tue, wed, thu, fri, sat</span>

<span class="nv">edb_audit_rotation_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">                         </span><span class="c1"># Automatic rotation of log files will</span>
<span class="w">                                                    </span><span class="c1"># happen after this many megabytes (MB)</span>
<span class="w">                                                    </span><span class="c1"># of log output.  0 to disable.</span>

<span class="nv">edb_audit_rotation_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">                      </span><span class="c1"># Automatic log file rotation will</span>
<span class="w">                                                    </span><span class="c1"># happen after this many seconds.</span>

<span class="nv">edb_audit_connect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">                           </span><span class="c1"># none, failed, all</span>

<span class="c1">#edb_audit_disconnect =&#39;none&#39;                       # none, all</span>

<span class="nv">edb_audit_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w">                         </span><span class="c1"># none, dml, ddl, select, error, rollback, all</span>

<span class="c1">#edb_audit_tag = &#39;&#39;                                 # Audit log session tracking tag.</span>
</pre></div>
</div>
<p>Note:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">edb_audit_filename</span> <span class="pre">=</span> <span class="pre">'audit-%Y-%m-%dT%H:%M:%S'</span></code> will create a file with name as <code class="docutils literal notranslate"><span class="pre">audit-2017-11-26T11:04:44.csv</span></code>.</p></li>
<li><p>Every file will be rolled off due to configuration <code class="docutils literal notranslate"><span class="pre">edb_audit_rotation_day</span> <span class="pre">=</span> <span class="pre">'every'</span></code></p></li>
</ul>
</div></blockquote>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>Create a table to copy logs from csv</p>
<blockquote>
<div><p><strong>For EnterpriseDB Postgres Version 9.6</strong>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">extra</span><span class="w"> </span><span class="nb">text</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<blockquote>
<div><p><strong>For EnterpriseDB Postgres version 10</strong>:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">postgres_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">log_time</span><span class="w"> </span><span class="k">timestamp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span>
<span class="w">  </span><span class="n">virtual_transaction_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">detail</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">hint</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">internal_query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">context</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">query_pos</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">statement_type</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">extra</span><span class="w"> </span><span class="nb">text</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>Create a log rotation config file as follows. Note:</p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li><p>EDB_AUDIT_LOG_DIRECTORY_PATH should have read privileges.</p></li>
<li><p>POSTGRES_HOME/bin/edb-psql should have execute privileges.</p></li>
</ul>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vi<span class="w">  </span>postgres_audit_log_rotation_config.txt

<span class="nv">EDB_AUDIT_LOG_DIRECTORY_PATH</span><span class="o">=</span>/opt/edb/as9.6/data/edb_audit/
<span class="nv">EDB_AUDIT_LOG_FILENAME_PREFIX</span><span class="o">=</span>audit-
<span class="nv">HOST</span><span class="o">=</span><span class="m">10</span>.11.21.41
<span class="nv">PORT</span><span class="o">=</span><span class="m">5432</span>
<span class="nv">USERNAME</span><span class="o">=</span>postgres
<span class="nv">PASSWORD</span><span class="o">=</span>hyperbad
<span class="nv">DATABASE</span><span class="o">=</span>postgres
<span class="nv">POSTGRES_HOME</span><span class="o">=</span>/opt/edb/as9.6/
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Create a log rotation script as follows. Note that following the script will look for yesterday’s log and copy yesterday’s csv to <code class="docutils literal notranslate"><span class="pre">public.postgres_log</span></code>.</p></li>
<li><p>Move both  <code class="docutils literal notranslate"><span class="pre">postgres_audit_log_rotation.sh</span></code> and <code class="docutils literal notranslate"><span class="pre">postgres_audit_log_rotation_config.txt</span></code> to <strong>{Postgres Installation Directory}/edb/as9.6/bin</strong>.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mv<span class="w"> </span>postgres_audit_log_rotation.sh<span class="w"> </span>opt/edb/as9.6/bin/.
mv<span class="w"> </span>postgres_audit_log_rotation_config.txt<span class="w"> </span>opt/edb/as9.6/bin/.
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Provide execute permission on <code class="docutils literal notranslate"><span class="pre">postgres_audit_log_rotation.sh</span></code>.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod<span class="w"> </span>+x<span class="w">  </span><span class="o">{</span>Postgres<span class="w"> </span>Installation<span class="w"> </span>Directory<span class="o">}</span>/edb/as9.6/bin/postgres_audit_log_rotation.sh
chmod<span class="w"> </span>+x<span class="w">  </span>opt/edb/as9.6/bin/postgres_audit_log_rotation.sh
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant read permission on <code class="docutils literal notranslate"><span class="pre">postgres_audit_log_rotation_config.txt</span></code></p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod<span class="w"> </span><span class="m">444</span><span class="w">  </span>opt/edb/as9.6/bin/postgres_audit_log_rotation_config.txt
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="7">
<li><p>Create a cron job to run at 1 am every day script as follows. This will sync yesterday’s log to public.postgres_log  at 1.00 AM.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w">   </span>sh<span class="w"> </span><span class="o">{</span>Postgres<span class="w"> </span>Installation<span class="w"> </span>Directory<span class="o">}</span>/edb/as9.6/bin/postres_audit_log_rotation.sh
<span class="o">{</span>Postgres<span class="w"> </span>Installation<span class="w"> </span>Directory<span class="o">}</span>/edb/as9.6/bin/postres_audit_log_rotation_config.txt
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<blockquote>
<div><p>For example, crontab -e</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w">   </span>sh<span class="w"> </span>/opt/edb/as9.6/bin/postres_audit_log_rotation.sh
/opt/edb/as9.6/bin/postres_audit_log_rotation_config.txt
</pre></div>
</div>
</div></blockquote>
<p><strong>For Ubuntu Users</strong></p>
<p>For example, crontab -e (Use bash instead of sh)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w">   </span>bash<span class="w"> </span>/opt/edb/as9.6/bin/postres_audit_log_rotation.sh
/opt/edb/as9.6/bin/postres_audit_log_rotation_config.txt
</pre></div>
</div>
</div></blockquote>
<ol class="arabic" start="8">
<li><p>Create a View</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">alation_postgres_logv</span><span class="w"> </span><span class="k">as</span>
<span class="k">SELECT</span>
<span class="w">  </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_line_num</span><span class="p">,</span>
<span class="w">  </span><span class="n">session_start_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">process_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">connection_from</span><span class="p">,</span>
<span class="w">  </span><span class="n">transaction_id</span><span class="p">,</span>
<span class="w">  </span><span class="n">command_tag</span><span class="p">,</span>
<span class="w">  </span><span class="n">message</span><span class="p">,</span>
<span class="w">  </span><span class="n">log_time</span><span class="p">,</span>
<span class="w">  </span><span class="n">sql_state_code</span><span class="p">,</span>
<span class="w">  </span><span class="n">error_severity</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="p">,</span>
<span class="w">  </span><span class="n">query</span><span class="p">,</span>
<span class="w">  </span><span class="n">database_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">application_name</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="n">postgres_log</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Grant access to Alation Service Account</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Grant SELECT on public.alation_postgres_logv to {Alation Service Account}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Update General Settings in Alation UI</p>
<p>Enter the view name <code class="docutils literal notranslate"><span class="pre">public.alation_postgres_logv</span></code> in the text entry box.</p>
<p>Select the <strong>Use EDB Audit Logs for Profiling</strong> checkbox:</p>
</li>
</ol>
</section>
</section>
<section id="a-8-impala-qli-script">
<span id="appendix-8"></span><h2>A.8 Impala QLI Script<a class="headerlink" href="#a-8-impala-qli-script" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>


<span class="k">def</span> <span class="nf">get_filenames_in_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="n">file_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="n">file_name_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">file_name_list</span>


<span class="k">def</span> <span class="nf">grant_full_access_for_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># grant access permission for the tmp file</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sudo&#39;</span><span class="p">,</span> <span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;777&#39;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">copy_file_to_hdfs</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dst_hdfs_path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># overwrite the file in HDFS if it exists already</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hadoop&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;-copyFromLocal&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">dst_hdfs_path</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot run hadoop command in the host. Cmd: &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">copy_logs_to_hdfs</span><span class="p">(</span><span class="n">src_log_dir_path</span><span class="p">,</span> <span class="n">dst_hdfs_dir_path</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
    <span class="c1"># scan audit logs and find the logs created on a specified date</span>
    <span class="n">file_name_list</span> <span class="o">=</span> <span class="n">get_filenames_in_dir</span><span class="p">(</span><span class="n">src_log_dir_path</span><span class="p">)</span>

    <span class="c1"># verify the file name, and only process log files</span>
    <span class="c1"># example name: impala_audit_event_log_1.0-1464403015360</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;impala_audit_event_log&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
    <span class="n">prefix_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">version_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="n">timestamp_len</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">file_name_len</span> <span class="o">=</span> <span class="n">prefix_len</span> <span class="o">+</span> <span class="n">version_len</span> <span class="o">+</span> <span class="n">timestamp_len</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">version_offset</span> <span class="o">=</span> <span class="n">prefix_len</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">timestamp_offset</span> <span class="o">=</span> <span class="n">version_offset</span> <span class="o">+</span> <span class="n">version_len</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># the file just before the start_time</span>
    <span class="n">pre_file_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pre_file_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># find all files created inside [start_time, end_time]</span>
    <span class="c1"># and the file created just before start_time (because this file should be updated here)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_name_list</span><span class="p">:</span>
        <span class="c1"># skip the file if the file name length does not match</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">!=</span> <span class="n">file_name_len</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># skip the file if the file name format does not match</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">[</span><span class="n">version_offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">version_offset</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span> <span class="ow">or</span> \
                <span class="n">file_name</span><span class="p">[</span><span class="n">timestamp_offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">timestamp_offset</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> \
                <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">prefix_len</span><span class="p">]</span> <span class="o">!=</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># extract the version of audit log</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="n">version_offset</span><span class="p">:</span><span class="n">version_offset</span> <span class="o">+</span> <span class="n">version_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Audit log version does not match, file name: &#39;</span> <span class="o">+</span> <span class="n">current_version</span>
            <span class="k">continue</span>

        <span class="c1"># extract time stamp</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="n">timestamp_offset</span><span class="p">:</span><span class="n">timestamp_offset</span> <span class="o">+</span> <span class="n">timestamp_len</span><span class="p">]</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">start_time</span> <span class="ow">and</span> <span class="n">pre_file_time</span> <span class="o">&lt;</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">pre_file_name</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="n">pre_file_time</span> <span class="o">=</span> <span class="n">timestamp</span>
            <span class="k">continue</span>

        <span class="c1"># if the timestamp is outside [start_time, end_time], then skip</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">start_time</span> <span class="ow">or</span> <span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">end_time</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># for legal log file names whose timestamp is inside [start_time, end_time]</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">src_log_dir_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span>
        <span class="n">dst_hdfs_path</span> <span class="o">=</span> <span class="n">dst_hdfs_dir_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span>
        <span class="n">copy_file_to_hdfs</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dst_hdfs_path</span><span class="p">)</span>

    <span class="c1"># copy the file created just before the start_time to hdfs</span>
    <span class="k">if</span> <span class="n">pre_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">src_log_dir_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pre_file_name</span>
        <span class="n">dst_hdfs_path</span> <span class="o">=</span> <span class="n">dst_hdfs_dir_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pre_file_name</span>
        <span class="n">copy_file_to_hdfs</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dst_hdfs_path</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">host_id</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Please specify the source log directory and HDFS log directory. For example,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;python fetch-log source-log-dir hdfs-log-dir</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;or</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;python fetch-log source-log-dir hdfs-log-dir start-date end-date</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;date inputs are in format YYYY-MM-DD&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">src_log_dir_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dst_hdfs_dir_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">host_id</span><span class="p">)</span>

    <span class="n">today_date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">one_day</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">yesterday_date</span> <span class="o">=</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">one_day</span>

    <span class="c1"># by default, the script only fetches log files for folder for yesterday</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">yesterday_date</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">today_date</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Please input the dates in YYYY-MM-DD format.&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># start time is the 00:00:00 of the start date in milliseconds</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">start_date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="c1"># end time is the 00:00:00 of the end date in milliseconds</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">end_date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="nb">print</span> <span class="s1">&#39;starting from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ms&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;ending at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ms&#39;</span>

    <span class="c1"># create the directory of dst_hdfs_dir_path in hdfs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hadoop&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;-test&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="n">dst_hdfs_dir_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hadoop&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;-mkdir&#39;</span><span class="p">,</span> <span class="n">dst_hdfs_dir_path</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot run hadoop command in the host. Cmd: &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># hadoop user may not have access to audit log, so we grant full access to it.</span>
    <span class="c1"># customers may want to modify this according to their security policy.</span>
    <span class="n">grant_full_access_for_dir</span><span class="p">(</span><span class="n">src_log_dir_path</span><span class="p">)</span>

    <span class="c1"># put log files in tmp dir to hadoop</span>
    <span class="n">copy_logs_to_hdfs</span><span class="p">(</span><span class="n">src_log_dir_path</span><span class="p">,</span> <span class="n">dst_hdfs_dir_path</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  
<div class="navigation-bar">

    <div class="navigation navigation--prev">
        
        <a class="navigation__link" href="ConfigureAlationDB.html">
            <button class="navigation__button">
                <i class="icon icon-left"></i>
            </button>
            <div class="navigation__title">
                <span class="heading">Previous</span> <br />Configure Alation DB
            </div>
        </a>
        
    </div>

    <div class="navigation navigation--next">
        
        <a class="navigation__link" title="Accesskey Alt(+Shift)+p" accesskey="p" href="../ComposeSSOAWSDataSources/index.html">
            <div class="navigation__title">
                <span class="heading">Next</span> <br />Compose SSO for Amazon Data Sources
            </div>
            <button class="navigation__button" title="Accesskey Alt(+Shift)+n" accesskey="n">
                <i class="icon icon-right"></i>
            </button>
        </a>
        
    </div>

</div>


</footer>

        </div>
      </div>

    </section>

    <div class="wy-nav-side wy-nav-secondary">
      <div class="wy-side-scroll">
        <div class="wy-side-scroll__content">
          <div class="wy-menu-secondary">
              <div class="comments">
    <a href="mailto:no-reply-docs-feedback@alation.com?subject=Documentation Feedback on datasources/AddDataSources/Appendix&body=Alation%20welcomes%20your%20comments%20on%20typos,%20content%20accuracy%20and%20completeness,%20and%20whether%20you%20found%20this%20page%20helpful.%20You%20will%20not%20receive%20a%20reply%20to%20this%20email.">
        <i class="icon icon-envelope" aria-hidden="true"></i>Request docs changes
    </a>
    <a href="#open-modal-pdf">
        <i class="icon icon-pdf" aria-hidden="true"></i>Download PDF
    </a>
</div>
              
                <p class="wy-menu-secondary-header">On this page</p>
                <ul>
<li><a class="reference internal" href="#">Appendix</a><ul>
<li><a class="reference internal" href="#a-1a-sql-server-extended-events-session-creation">A.1a SQL Server Extended Events Session Creation</a><ul>
<li><a class="reference internal" href="#query-to-create-extended-events-session">Query to create extended events session</a><ul>
<li><a class="reference internal" href="#query-to-delete-and-recreate-the-session">Query to Delete and Recreate the Session</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-database-id-instead-of-database-name">Using Database ID instead of Database Name</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-1b-sql-server-2008-extended-events-session-creation">A.1b SQL Server 2008 Extended Events Session Creation</a><ul>
<li><a class="reference internal" href="#query-to-create-extended-events-session-sql-server-2008">Query To create extended events session SQL Server 2008</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-1c-sql-server-trace-script">A.1c SQL Server Trace Script</a></li>
<li><a class="reference internal" href="#a-1d-sql-server-ingestion-from-custom-table-setup">A.1d SQL Server Ingestion from Custom Table Setup</a></li>
<li><a class="reference internal" href="#a-2-teradata-query-log-view-sql">A.2 Teradata Query Log View SQL</a><ul>
<li><a class="reference internal" href="#dbc">DBC</a></li>
<li><a class="reference internal" href="#reduced-query-log-view">Reduced Query Log View</a></li>
<li><a class="reference internal" href="#pdcr">PDCR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-3-amazon-redshift-query-log-table">A.3 Amazon Redshift Query Log Table</a><ul>
<li><a class="reference internal" href="#alternative-sql-does-not-automatically-create-table">Alternative SQL (does not automatically create table)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-4-oracle-query-log-view">A.4 Oracle Query Log View</a><ul>
<li><a class="reference internal" href="#oracle-qli-view-using-ash-table">Oracle QLI View using ASH table</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-5-vertica-query-log">A.5 Vertica Query Log</a></li>
<li><a class="reference internal" href="#a-6-netezza-query-log-view">A.6 Netezza Query Log View</a><ul>
<li><a class="reference internal" href="#how-do-you-capture-history-for-a-particular-database">How do you capture history for a particular database?</a></li>
<li><a class="reference internal" href="#how-do-you-capture-history-for-a-particular-user-group-group-name">How do you capture history for a particular user group &lt;group_name&gt; ?</a></li>
<li><a class="reference internal" href="#how-to-add-a-particular-user-user-name-to-group-group-name-for-which-collect-history-is-on-or-default">How to add a particular user &lt;user_name&gt; to group &lt;group_name&gt; for which <code class="docutils literal notranslate"><span class="pre">COLLECT</span> <span class="pre">HISTORY</span></code> is <code class="docutils literal notranslate"><span class="pre">ON</span></code> or <code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code>?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-7-postgres-qli-setup">A.7 Postgres QLI Setup</a><ul>
<li><a class="reference internal" href="#csv-logging-with-no-log-rotation">CSV Logging with No Log Rotation</a><ul>
<li><a class="reference internal" href="#update-general-settings-in-alation-ui">Update General Settings in Alation UI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#csv-logging-with-log-rotation">CSV Logging with Log rotation</a></li>
<li><a class="reference internal" href="#edb-audit-logs-with-no-log-rotation">EDB Audit logs with No Log Rotation</a></li>
<li><a class="reference internal" href="#edb-postgres-server-with-audit-log-rotation">EDB Postgres Server with Audit Log Rotation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-8-impala-qli-script">A.8 Impala QLI Script</a></li>
</ul>
</li>
</ul>

              
            </div>
          </div>
      </div>
    </div>

  </div>

  
  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->

  
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
      <script type="text/javascript" src="../../_static/copybutton.js"></script>
      <script type="text/javascript" src="../../_static/tabs.js"></script>
      <script type="text/javascript" src="../../_static/js/rtd_sphinx_search.min.js"></script>
  
  <script type="text/javascript" src="../../_static/searchtools.js"></script> <script type="text/javascript" id="idPiwikScriptPlaceholder"></script><script type="text/javascript" src="../../_static/js/main.bundle.js"></script>
  <script type="text/javascript" src="../../_static/js/runtime.bundle.js"></script>

  
  

  
    <div id="open-modal-pdf" class="modal-window">
<div>
  <a href="#" title="Close" class="modal-close">Close</a>
  <h4>Alation Documentation PDF</h4>
  <p>This PDF contains all our documentation and is more than <b>120 MB</b> in size. We recommend using an ethernet or Wi-Fi connection for downloading.</p>
  <br>
  <div class="modal-buttons">
    <a href="https://pdf-docs.alation.com/AlationUserDocs.pdf" class="btn-cta btn-cta--primary" target="_blank">
      Download PDF
    </a>
    <a href="#" title="Close" class="btn-cta">Cancel</a>
  </div>
</div>
  

</body>
</html>
<!--3.6.17-->